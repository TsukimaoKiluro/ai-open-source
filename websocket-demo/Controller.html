<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AIæ–¹è¨€æ”¿åŠ¡åŠ©æ‰‹</title>
  <!-- é¢„åŠ è½½ VAD åº“ ä½¿ç”¨ unpkg -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
    <script src="https://unpkg.com/onnxruntime-web@1.14.0/dist/ort.min.js"></script>
    <script src="https://unpkg.com/@ricky0123/vad-web@0.0.7/dist/bundle.min.js"></script>
    <style>
      :root {
        --color-darkest: #222831;
        --color-dark: #393e46;
        --color-primary: #00adb5;
        --color-light: #eeeeee;
        --color-lightest: #eeeeee;
      }

      body {
        font-family: "Segoe UI", Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 0;
        background-color: #fff;
        color: var(--color-darkest);
        min-height: 100vh;
      }

      html {
        background-color: #fff;
      }

      .header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background-color: #fff;
        background-image: linear-gradient(to bottom, #eeeeee 60%, #fff 100%);
        box-shadow: 0 4px 12px rgba(34, 40, 49, 0.08);
        z-index: 1000;
        border-bottom: 1px solid #eeeeee;
      }

      .header-content {
        max-width: 800px;
        margin: 0 auto;
        padding: 15px 20px;
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .user-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background-color: var(--color-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.2em;
        /* box-shadow: 0 2px 8px rgba(191, 36, 42, 0.3); */
        border: 2px solid var(--color-light);
        transition: transform 0.2s ease;
      }

      .user-avatar:hover {
        transform: scale(1.05);
      }

      .user-info {
        flex: 1;
      }

      .user-name {
        font-weight: bold;
        margin: 0;
        color: var(--color-darkest);
        font-size: 1.1em;
      }

      .user-status {
        color: var(--color-dark);
        font-size: 0.9em;
        margin: 4px 0 0 0;
      }

      .main-content {
        margin-top: 90px;
        padding: 20px;
        background-color: #fff;
        border-radius: 20px;
        /* box-shadow: 0 4px 16px rgba(191, 36, 42, 0.1); */
        box-shadow: 0 4px 16px rgba(34, 40, 49, 0.06);
        border: 1px solid #eeeeee;
      }

      h1 {
        /* color: var(--color-lightest); */
        font-size: 1.8em;
        margin-bottom: 25px;
        text-align: center;
      }

      #messages {
        height: 400px;
        border: 1px solid rgba(81, 81, 81, 0.15);
        margin-bottom: 25px;
        padding: 15px;
        overflow-y: auto;
        border-radius: 15px;
        background-color: rgba(255, 255, 255, 0.15);
      }

      #messages div {
        margin: 8px 0;
        padding: 10px 15px;
        border-radius: 12px;
        background-color: #fff;
        /* box-shadow: 0 2px 6px rgba(191, 36, 42, 0.1); */
        box-shadow: 0 2px 6px rgba(34, 40, 49, 0.04);
        transition: transform 0.2s ease;
        color: var(--color-darkest);
        border: 1px solid #eeeeee;
      }

      #messages div:hover {
        transform: translateX(5px);
      }

      /* ç”¨æˆ·è¯­éŸ³è¾“å…¥æ¶ˆæ¯æ ·å¼ */
      #messages .user-message {
        background-color: #00adb5 !important;
        color: #fff !important;
        border-radius: 12px 12px 0 12px !important;
        margin-left: auto;
        margin-right: 0;
        max-width: 70%;
        text-align: right;
        box-shadow: 0 2px 6px rgba(0, 173, 181, 0.3) !important;
        border: 1px solid #00adb5 !important;
        display: block;
      }

      #messages .user-message:hover {
        transform: translateX(-5px);
      }

      /* è¯­è¨€å¤§æ¨¡å‹å›å¤æ ·å¼ */
      #messages .ai-message {
        background-color: #fff !important;
        color: #222831 !important;
        border-radius: 12px 12px 12px 0 !important;
        margin-right: auto;
        margin-left: 0;
        max-width: 70%;
        text-align: left;
        box-shadow: 0 2px 6px rgba(34, 40, 49, 0.04) !important;
        border: 1px solid #eeeeee !important;
        display: block;
      }

      #trong {
        color: var(--color-primary);
        color: #00adb5;
      }
      .interim-message {
        margin: 8px 0;
        padding: 10px 15px;
        border-radius: 12px;
        background-color: rgba(226, 103, 107, 0.06);
        color: var(--color-darkest);
        font-style: italic;
        border: 1px dashed rgba(191, 36, 42, 0.08);
      }

      #messageForm {
        display: flex;
        gap: 12px;
        padding: 15px;
        border-radius: 15px;
        background-color: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(83, 83, 83, 0.15);
      }

      #messageInput {
        flex: 1;
        padding: 12px 20px;
        border: 1px solid #eeeeee;
        border-radius: 12px;
        font-size: 1em;
        background-color: white;
        color: var(--color-darkest);
        /* box-shadow: inset 0 2px 4px rgba(191, 36, 42, 0.05); */
        transition: all 0.2s ease;
      }

      #messageInput:focus {
        outline: none;
        box-shadow: inset 0 2px 4px rgba(43, 8, 9, 0.2),
          0 0 0 3px var(--color-primary);
      }

      #messageInput::placeholder {
        color: var(--color-light);
      }
      button {
        padding: 12px 24px;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        color: white;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.95em;
        box-shadow: 0 2px 6px rgba(10, 38, 57, 0.15);
      }

      button[type="submit"] {
        background-color: var(--color-primary);
        border: 1px solid rgba(139, 196, 234, 0.2);
      }

      button[type="submit"]:hover {
        background-color: var(--color-dark);
        transform: translateY(-2px);
        border-color: var(--color-light);
      }

      #voiceButton {
        background-color: var(--color-primary);
      }

      #voiceButton:hover {
        background-color: var(--color-darkest);
        transform: translateY(-2px);
      }

      #voiceButton.recording {
        background-color: var(--color-primary);
        animation: pulse 1.5s infinite;
        box-shadow: 0 0 0 0 #00adb5;
      }

      #voiceButton.active {
        background-color: var(--color-primary);
        animation: pulse 1.5s infinite;
        box-shadow: 0 0 0 0 #00adb5;
      }

      #micButton {
        background-color: var(--color-primary);
        padding: 12px 20px;
      }

      #micButton:hover {
        background-color: var(--color-darkest);
        transform: translateY(-2px);
      }

      .mic-selector {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 8px 32px #00adb5;
        z-index: 2000;
        min-width: 400px;
        max-width: 90%;
        border: 2px solid var(--color-light);
      }

      .mic-selector.hidden {
        display: none;
      }

      .mic-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1999;
      }

      .mic-overlay.hidden {
        display: none;
      }

      .mic-selector h3 {
        margin: 0 0 20px 0;
        color: var(--color-darkest);
        font-size: 1.3em;
      }

      .mic-list {
        margin-bottom: 20px;
      }

      .mic-item {
        padding: 12px 15px;
        margin: 8px 0;
        border: 2px solid #00adb5;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
      }

      .mic-item:hover {
        background: rgba(242, 189, 191, 0.3);
        border-color: var(--color-light);
        transform: translateX(5px);
      }

      .mic-item.selected {
        background: var(--color-lightest);
        border-color: var(--color-primary);
        font-weight: bold;
      }

      .mic-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }

      .mic-actions button {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
      }

      .mic-actions .confirm {
        background-color: var(--color-primary);
        color: white;
      }

      .mic-actions .confirm:hover {
        background-color: var(--color-dark);
      }

      .mic-actions .cancel {
        background-color: #e0e0e0;
        color: #333;
      }

      .mic-actions .cancel:hover {
        background-color: #d0d0d0;
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 #00adb5;
        }
        70% {
          box-shadow: 0 0 0 10px rgba(191, 36, 42, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(191, 36, 42, 0);
        }
      }

      /* æ¨¡å¼åˆ‡æ¢æ ·å¼ */
      .mode-selector {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 15px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        margin-bottom: 15px;
        border: 1px solid rgba(82, 82, 82, 0.15);
      }

      .mode-label {
        font-weight: 600;
        color: var(--color-darkest);
        font-size: 0.95em;
      }

      .mode-buttons {
        display: flex;
        gap: 8px;
      }

      .mode-btn {
        padding: 8px 16px;
        border: 2px solid rgba(83, 83, 83, 0.3);
        border-radius: 8px;
        background: white;
        color: var(--color-dark);
        font-size: 0.9em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: none;
      }

      .mode-btn:hover {
        background: rgba(173, 173, 173, 0.3);
        border-color: var(--color-light);
        transform: none;
      }

      .mode-btn.active {
        background: var(--color-primary);
        color: white;
        border-color: var(--color-primary);
      }

      .mode-description {
        font-size: 0.85em;
        color: var(--color-dark);
        margin-left: auto;
        font-style: italic;
      }

      /* æŒ‰ä½å½•éŸ³æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
      #voiceButton.press-to-talk {
        background: linear-gradient(
          135deg,
          var(--color-light),
          var(--color-primary)
        );
        position: relative;
      }

      #voiceButton.press-to-talk::after {
        content: "æŒ‰ä½è¯´è¯";
        position: absolute;
        bottom: -20px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.75em;
        white-space: nowrap;
        color: var(--color-dark);
      }

      #voiceButton.press-to-talk.pressing {
        background: var(--color-darkest);
        animation: pulse 1.5s infinite;
      }

      #voiceButton.press-to-talk.pressing::after {
        content: "å½•éŸ³ä¸­...";
        color: var(--color-primary);
        font-weight: bold;
      }

      /* è®¾ç½®æŒ‰é’®å’Œèœå•æ ·å¼ */
      .settings-container {
        position: relative;
        margin-left: auto;
      }

      .settings-button {
        background: var(--color-primary);
        border: none;
        border-radius: 15%;
        width: 40px;
        height: 40px;
        cursor: pointer;
        font-size: 1.2em;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        /* box-shadow: 0 2px 8px rgba(191, 36, 42, 0.3); */
      }

      .settings-button:hover {
        background: var(--color-dark);
        /* transform: rotate(90deg); */
      }

      .settings-dropdown {
        position: absolute;
        top: 50px;
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        min-width: 400px;
        max-height: 80vh;
        overflow-y: auto;
        z-index: 2000;
        display: none;
        border: 2px solid var(--color-light);
      }

      .settings-dropdown.show {
        display: block;
        animation: slideDown 0.3s ease;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .settings-header {
        padding: 20px;
        border-bottom: 2px solid rgba(191, 36, 42, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .settings-header h3 {
        margin: 0;
        color: var(--color-darkest);
        font-size: 1.2em;
      }

      .settings-close {
        background: none;
        border: none;
        font-size: 1.5em;
        color: var(--color-dark);
        cursor: pointer;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
      }

      .settings-close:hover {
        background: rgba(191, 36, 42, 0.1);
        color: var(--color-primary);
      }

      .settings-body {
        padding: 20px;
      }

      .settings-section {
        margin-bottom: 25px;
      }

      .settings-section:last-child {
        margin-bottom: 0;
      }

      .settings-section-title {
        font-size: 1em;
        font-weight: 600;
        color: var(--color-darkest);
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(191, 36, 42, 0.1);
      }

      .settings-param {
        margin-bottom: 15px;
      }

      .settings-param-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        font-size: 0.9em;
        color: var(--color-dark);
      }

      .settings-param-name {
        font-weight: 500;
      }

      .settings-param-value {
        font-weight: 600;
        color: var(--color-primary);
        min-width: 60px;
        text-align: right;
      }

      .settings-param-input {
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: rgba(93, 93, 93, 0.1);
        outline: none;
        -webkit-appearance: none;
      }

      .settings-param-input::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--color-primary);
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .settings-param-input::-webkit-slider-thumb:hover {
        background: var(--color-dark);
        transform: scale(1.2);
      }

      .settings-param-input::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--color-primary);
        cursor: pointer;
        border: none;
        transition: all 0.2s ease;
      }

      .settings-param-input::-moz-range-thumb:hover {
        background: var(--color-dark);
        transform: scale(1.2);
      }

      .settings-param-desc {
        font-size: 0.8em;
        color: #666;
        margin-top: 5px;
        font-style: italic;
      }

      .settings-actions {
        display: flex;
        gap: 10px;
        padding-top: 15px;
        border-top: 1px solid rgba(191, 36, 42, 0.1);
      }

      .settings-actions button {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.95em;
      }

      .settings-save {
        background: var(--color-primary);
        color: white;
      }

      .settings-save:hover {
        background: var(--color-dark);
        transform: translateY(-2px);
      }

      .settings-reset {
        background: #e0e0e0;
        color: #333;
      }

      .settings-reset:hover {
        background: #d0d0d0;
      }

      .settings-preset {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 10px;
      }

      .preset-btn {
        padding: 6px 12px;
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(82, 82, 82, 0.15);
        border-radius: 6px;
        font-size: 0.85em;
        cursor: pointer;
        transition: all 0.2s ease;
        color: var(--color-dark);
      }

      .preset-btn:hover {
        background: var(--color-lightest);
        border-color: var(--color-primary);
      }

      .preset-btn.active {
        background: var(--color-primary);
        color: white;
        border-color: var(--color-primary);
      }

      #audioButton {
        background-color: #e53935;
        color: #fff;
      }

      #audioButton:hover {
        background-color: #b71c1c;
      }

      /* ç”¨æˆ·è¯­éŸ³è¾“å…¥æ¶ˆæ¯æ ·å¼ */
      .user-message {
        background-color: #00adb5;
        color: #fff;
        border-radius: 12px 12px 0 12px;
        margin-left: auto;
        margin-right: 0;
        max-width: 70%;
        text-align: right;
        box-shadow: 0 2px 6px rgba(34, 40, 49, 0.04);
        border: 1px solid #00adb5;
      }

      /* è¯­è¨€å¤§æ¨¡å‹å›å¤æ ·å¼ */
      .ai-message {
        background-color: #fff;
        color: #222831;
        border-radius: 12px 12px 12px 0;
        margin-right: auto;
        margin-left: 0;
        max-width: 70%;
        text-align: left;
        box-shadow: 0 2px 6px rgba(34, 40, 49, 0.04);
        border: 1px solid #eeeeee;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="header-content">
        <div class="user-avatar" id="userAvatar">è®¿</div>
        <div class="user-info">
          <p class="user-name" id="userName">è®¿å®¢</p>
          <p class="user-status">åœ¨çº¿</p>
        </div>
        <div class="settings-container">
          <button class="settings-button" id="settingsButton" title="è®¾ç½®">
            ä¸‰
          </button>
          <div class="settings-dropdown" id="settingsDropdown">
            <div class="settings-header">
              <h3>ç³»ç»Ÿè®¾ç½®</h3>
              <button class="settings-close" id="settingsClose">Ã—</button>
            </div>
            <div class="settings-body">
              <!-- VAD å‚æ•°è®¾ç½® -->
              <div class="settings-section">
                <div class="settings-section-title">ğŸ™ï¸ ç«¯ç‚¹æ£€æµ‹å‚æ•°ï¼ˆVADï¼‰</div>

                <!-- é¢„è®¾æ–¹æ¡ˆ -->
                <div class="settings-param">
                  <div class="settings-param-label">
                    <span class="settings-param-name">å¿«é€Ÿé¢„è®¾</span>
                  </div>
                  <div class="settings-preset">
                    <button class="preset-btn" data-preset="fast">
                      å¿«é€Ÿå“åº”
                    </button>
                    <button class="preset-btn active" data-preset="balanced">
                      å¹³è¡¡æ¨¡å¼
                    </button>
                    <button class="preset-btn" data-preset="tolerant">
                      å®¹é”™æ¨¡å¼
                    </button>
                    <button class="preset-btn" data-preset="custom">
                      è‡ªå®šä¹‰
                    </button>
                  </div>
                </div>

                <!-- å¼€å§‹æ£€æµ‹é˜ˆå€¼ -->
                <div class="settings-param">
                  <div class="settings-param-label">
                    <span class="settings-param-name">å¼€å§‹æ£€æµ‹é˜ˆå€¼</span>
                    <span class="settings-param-value" id="posThresholdValue"
                      >0.5</span
                    >
                  </div>
                  <input
                    type="range"
                    class="settings-param-input"
                    id="posThreshold"
                    min="0.3"
                    max="0.9"
                    step="0.05"
                    value="0.5"
                  />
                  <div class="settings-param-desc">
                    å€¼è¶Šä½è¶Šå®¹æ˜“å¼€å§‹å½•éŸ³ï¼ˆæ¨èï¼š0.4-0.6ï¼‰
                  </div>
                </div>

                <!-- ç»“æŸæ£€æµ‹é˜ˆå€¼ -->
                <div class="settings-param">
                  <div class="settings-param-label">
                    <span class="settings-param-name">ç»“æŸæ£€æµ‹é˜ˆå€¼</span>
                    <span class="settings-param-value" id="negThresholdValue"
                      >0.35</span
                    >
                  </div>
                  <input
                    type="range"
                    class="settings-param-input"
                    id="negThreshold"
                    min="0.15"
                    max="0.6"
                    step="0.05"
                    value="0.35"
                  />
                  <div class="settings-param-desc">
                    å€¼è¶Šä½è¶Šå¿«ç»“æŸå½•éŸ³ï¼ˆæ¨èï¼š0.25-0.4ï¼‰
                  </div>
                </div>

                <!-- åœé¡¿å®¹å¿å¸§æ•°ï¼ˆåç½®ç¼“å†²ï¼‰ -->
                <div class="settings-param">
                  <div class="settings-param-label">
                    <span class="settings-param-name"
                      >åç½®ç¼“å†²ï¼ˆå¥å°¾ä¿æŠ¤ï¼‰</span
                    >
                    <span class="settings-param-value" id="redemptionValue"
                      >0.38s (12å¸§)</span
                    >
                  </div>
                  <input
                    type="range"
                    class="settings-param-input"
                    id="redemption"
                    min="6"
                    max="30"
                    step="1"
                    value="12"
                  />
                  <div class="settings-param-desc">
                    é™éŸ³åç»§ç»­å½•éŸ³æ—¶é•¿ï¼Œä¿æŠ¤å¥å°¾éŸ³èŠ‚ï¼ˆæ¨èï¼š10-14å¸§ï¼‰
                  </div>
                </div>

                <!-- å‰ç½®ç¼“å†²å¸§æ•°ï¼ˆå¥é¦–ä¿æŠ¤ï¼‰ -->
                <div class="settings-param">
                  <div class="settings-param-label">
                    <span class="settings-param-name"
                      >å‰ç½®ç¼“å†²ï¼ˆå¥é¦–ä¿æŠ¤ï¼‰</span
                    >
                    <span class="settings-param-value" id="preSpeechValue"
                      >0.19s (6å¸§)</span
                    >
                  </div>
                  <input
                    type="range"
                    class="settings-param-input"
                    id="preSpeech"
                    min="1"
                    max="10"
                    step="1"
                    value="6"
                  />
                  <div class="settings-param-desc">
                    è¯­éŸ³å‰é¢å¤–ä¿ç•™æ—¶é•¿ï¼Œä¿æŠ¤å¥é¦–éŸ³èŠ‚ï¼ˆæ¨èï¼š5-8å¸§ï¼‰
                  </div>
                </div>

                <!-- æœ€å°è¯­éŸ³å¸§æ•° -->
                <div class="settings-param">
                  <div class="settings-param-label">
                    <span class="settings-param-name">æœ€å°è§¦å‘æ—¶é•¿</span>
                    <span class="settings-param-value" id="minSpeechValue"
                      >0.13s (4å¸§)</span
                    >
                  </div>
                  <!-- ç½®ä¿¡åº¦é˜ˆå€¼ -->
                  <div class="settings-param">
                    <div class="settings-param-label">
                      <span class="settings-param-name">ç½®ä¿¡åº¦é˜ˆå€¼</span>
                      <span class="settings-param-value" id="confidenceValue"
                        >0.7</span
                      >
                    </div>
                    <input
                      type="range"
                      class="settings-param-input"
                      id="confidenceThreshold"
                      min="0.5"
                      max="0.99"
                      step="0.01"
                      value="0.7"
                    />
                    <div class="settings-param-desc">
                      ç«¯ç‚¹æ£€æµ‹ç½®ä¿¡åº¦ï¼Œè¶Šé«˜è¶Šä¸¥æ ¼ï¼ˆæ¨èï¼š0.6-0.8ï¼‰
                    </div>
                  </div>
                  <input
                    type="range"
                    class="settings-param-input"
                    id="minSpeech"
                    min="2"
                    max="10"
                    step="1"
                    value="4"
                  />
                  <div class="settings-param-desc">
                    è¿‡æ»¤çŸ­å™ªéŸ³ï¼ˆæ¨èï¼š3-6å¸§ï¼‰
                  </div>
                </div>
              </div>

              <!-- ASR Model Selection -->
              <div class="settings-section">
                <div class="settings-section-title">ğŸ¤– è¯†åˆ«æ¨¡å‹é€‰æ‹©</div>

                <div class="settings-param">
                  <div class="settings-param-label">
                    <span class="settings-param-name">å½“å‰æ¨¡å‹</span>
                    <span class="settings-param-value" id="currentModelName"
                      >åŠ è½½ä¸­...</span
                    >
                  </div>
                  <select
                    class="settings-param-input"
                    id="modelSelect"
                    style="
                      width: 100%;
                      padding: 8px;
                      border-radius: 4px;
                      border: 1px solid #ddd;
                    "
                  >
                    <option value="paraformer-zh">Paraformer-zh (é»˜è®¤)</option>
                    <option value="paraformer-large">
                      Paraformer-zh Large (é«˜ç²¾åº¦)
                    </option>
                  </select>
                  <div class="settings-param-desc">
                    æ›´æ¢æ¨¡å‹éœ€è¦ç­‰å¾…åŠ è½½æ—¶é—´
                  </div>
                </div>
              </div>

              <!-- LLM æç¤ºè¯è®¾ç½® -->
              <div class="settings-section">
                <div class="settings-section-title">ğŸ’¬ AI æç¤ºè¯è®¾ç½®</div>

                <div class="settings-param">
                  <div class="settings-param-label">
                    <span class="settings-param-name">ç³»ç»Ÿæç¤ºè¯</span>
                  </div>
                  <textarea
                    class="settings-param-input"
                    id="systemPrompt"
                    rows="4"
                    style="
                      width: 100%;
                      padding: 8px;
                      border-radius: 4px;
                      border: 1px solid #ddd;
                      resize: vertical;
                      font-family: inherit;
                    "
                    placeholder="è§’è‰²ï¼š æ‚¨æ˜¯â€œæ”¿åŠ¡é€šâ€AIåŠ©æ‰‹ï¼Œä¸€åä¸“ä¸šçš„æ•°å­—æ”¿åŠ¡é¡¾é—®ã€‚
æ ¸å¿ƒä»»åŠ¡ï¼š ä¸ºç”¨æˆ·æä¾›å…³äºç¤¾ä¿ã€å…¬ç§¯é‡‘ã€åŒ»ç–—ã€æˆ·ç±ã€ç¨åŠ¡ç­‰å¸¸è§æ”¿åŠ¡äº‹åŠ¡çš„æ”¿ç­–è§£è¯»ä¸åŠç†æµç¨‹æŒ‡å—ã€‚
å›ç­”åŸåˆ™ï¼š

ä¿¡æ¯å‡†ç¡®ï¼šä¸¥æ ¼ä¾æ®ä¸­å›½ç›¸å…³æ³•å¾‹æ³•è§„ä¸åœ°æ–¹æ”¿åºœæœ€æ–°å…¬å¼€æ”¿ç­–è¿›è¡Œè§£ç­”ã€‚å¯¹äºæ— æ³•ç¡®è®¤çš„åŠ¨æ€ä¿¡æ¯ï¼ŒåŠ¡å¿…å¼•å¯¼ç”¨æˆ·å‰å¾€å®˜æ–¹å¹³å°æˆ–çƒ­çº¿æ ¸å®ã€‚

æµç¨‹æ¸…æ™°ï¼šåˆ†æ­¥éª¤è¯´æ˜åŠäº‹æµç¨‹ï¼Œæ˜ç¡®æŒ‡å‡ºåŠç†åœ°ç‚¹ï¼ˆçº¿ä¸Šå¹³å°/çº¿ä¸‹å¤§å…ï¼‰ã€æ‰€éœ€ææ–™ã€åŠç†æ—¶é™åŠå…³é”®æ³¨æ„äº‹é¡¹ã€‚

è¯­è¨€è§„èŒƒï¼šä½¿ç”¨ç®€æ´ã€ä¸“ä¸šã€ç¤¼è²Œçš„ä¹¦é¢è¯­ï¼Œé¿å…æ­§ä¹‰ã€‚å…³é”®ä¿¡æ¯ï¼ˆå¦‚ææ–™åç§°ã€æˆªæ­¢æ—¥æœŸï¼‰å¯é€‚å½“å¼ºè°ƒã€‚

ä¸»åŠ¨å¼•å¯¼ï¼šåœ¨è§£ç­”ç»“å°¾ï¼Œä¸»åŠ¨æä¾›ä¸‹ä¸€æ­¥å»ºè®®ï¼Œä¾‹å¦‚ï¼šâ€œæ‚¨å¯ä»¥å‰å¾€XXå¸‚äººç¤¾å±€å®˜ç½‘ä¸‹è½½ç”³è¯·è¡¨â€ï¼Œæˆ–â€œå»ºè®®æ‚¨æ‹¨æ‰“12333çƒ­çº¿ç¡®è®¤æ‚¨çš„å…·ä½“ç¼´è´¹å¹´é™â€ã€‚
é‡è¦å£°æ˜ï¼š æ‚¨æä¾›çš„æ˜¯é€šç”¨æ€§æŒ‡å—ï¼Œä¸å…·æ³•å¾‹æ•ˆåŠ›ã€‚æœ€ç»ˆè§£é‡Šæƒä¸æ‰§è¡Œæ ‡å‡†å‡ä»¥å½“åœ°æ”¿åŠ¡éƒ¨é—¨çš„å®˜æ–¹é€šçŸ¥ä¸ºå‡†ã€‚"
                  ></textarea>
                  <div class="settings-param-desc">
                    æ¯æ¬¡ä¸AIå¯¹è¯æ—¶ï¼Œæ­¤æç¤ºè¯å°†ä½œä¸ºç³»ç»Ÿè§’è‰²å‘é€
                  </div>
                </div>
              </div>

              <!-- è¯­éŸ³æ•´åˆæäº¤è®¾ç½® -->
              <div class="settings-section">
                <div class="settings-section-title">â±ï¸ è¯­éŸ³æ•´åˆæäº¤</div>
                <div class="settings-param">
                  <div class="settings-param-label">
                    <span class="settings-param-name">æ•´åˆç­‰å¾…æ—¶é—´ (ç§’)</span>
                    <span class="settings-param-value" id="inactivityValue">4</span>
                  </div>
                  <input
                    type="range"
                    class="settings-param-input"
                    id="inactivityTimeout"
                    min="2"
                    max="12"
                    step="1"
                    value="4"
                  />
                  <div class="settings-param-desc">
                    ä»ä¸Šä¸€æ¬¡è¯­éŸ³ç»“æœå¼€å§‹ï¼Œè‹¥åœ¨è¯¥æ—¶é—´å†…æ— æ–°è¯­éŸ³åˆ™æ•´åˆæœŸé—´æ‰€æœ‰è¯†åˆ«æ–‡æœ¬ä¸€æ¬¡æ€§å‘é€ç»™ AIï¼›å¦åˆ™ç»§ç»­ç­‰å¾…ã€‚
                  </div>
                </div>
              </div>

                <div class="settings-param">
                  <div class="settings-param-label">
                    <span class="settings-param-name">é¢„è®¾æç¤ºè¯æ¨¡æ¿</span>
                  </div>
                  <select
                    class="settings-param-input"
                    id="promptTemplate"
                    style="
                      width: 100%;
                      padding: 8px;
                      border-radius: 4px;
                      border: 1px solid #ddd;
                    "
                  >
                    <option value="">é€‰æ‹©æ¨¡æ¿...</option>
                    <option value="dialect">1</option>
                    <option value="teacher">2</option>
                    <option value="friend">3</option>
                    <option value="professional">4</option>
                  </select>
                  <div class="settings-param-desc">å¿«é€Ÿåº”ç”¨å¸¸ç”¨æç¤ºè¯æ¨¡æ¿</div>
                </div>
              </div>

              <!-- æ“ä½œæŒ‰é’® -->
              <div class="settings-actions">
                <button class="settings-reset" id="settingsReset">
                  æ¢å¤é»˜è®¤
                </button>
                <button class="settings-save" id="settingsSave">
                  ä¿å­˜å¹¶åº”ç”¨
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-content">
      <h1>AIæ–¹è¨€è¯†åˆ«åŠ©æ‰‹</h1>

      <!-- æ¨¡å¼é€‰æ‹©å™¨ -->
      <div class="mode-selector">
        <span class="mode-label">å½•éŸ³æ¨¡å¼:</span>
        <div class="mode-buttons">
          <button class="mode-btn" id="mode1Btn" data-mode="1">æŒ‰ä½å½•éŸ³</button>
          <button class="mode-btn active" id="mode2Btn" data-mode="2">
            ç«¯ç‚¹æ£€æµ‹
          </button>
        </div>
        <span class="mode-description" id="modeDescription"
          >è‡ªåŠ¨æ£€æµ‹è¯­éŸ³ç«¯ç‚¹</span
        >
      </div>

      <div id="messages"></div>
      <form id="messageForm">
        <input
          type="text"
          id="messageInput"
          placeholder="è¯·è¾“å…¥æˆ–è¯´å‡ºæ‚¨è¦è¯†åˆ«çš„æ–¹è¨€..."
          required
        />
        <button type="button" id="voiceButton">å¼€å¯è¯­éŸ³æ£€æµ‹</button>
        <button type="button" id="micButton">é€‰æ‹©éº¦å…‹é£</button>
        <button type="button" id="audioButton">æµå¼éŸ³é¢‘</button>
        <button type="submit">å‘é€</button>
      </form>
    </div>

    <!-- éº¦å…‹é£é€‰æ‹©å™¨ -->
    <div class="mic-overlay hidden" id="micOverlay"></div>
    <div class="mic-selector hidden" id="micSelector">
      <h3>é€‰æ‹©éº¦å…‹é£è®¾å¤‡</h3>
      <div class="mic-list" id="micList"></div>
      <div class="mic-actions">
        <button class="cancel" id="micCancel">å–æ¶ˆ</button>
        <button class="confirm" id="micConfirm">ç¡®è®¤</button>
      </div>
    </div>

    <script type="module">
  // å·²é€šè¿‡ <script> å…¨å±€å¼•å…¥ marked.jsï¼Œæ— éœ€ import
      const messagesDiv = document.getElementById("messages");
      const messageForm = document.getElementById("messageForm");
      const messageInput = document.getElementById("messageInput");
      const voiceButton = document.getElementById("voiceButton");
      const micButton = document.getElementById("micButton");
      const micSelector = document.getElementById("micSelector");
      const micOverlay = document.getElementById("micOverlay");
      const micList = document.getElementById("micList");
      const micCancel = document.getElementById("micCancel");
      const micConfirm = document.getElementById("micConfirm");
      const userNameElement = document.getElementById("userName");
      const userAvatarElement = document.getElementById("userAvatar");
      const mode1Btn = document.getElementById("mode1Btn");
      const mode2Btn = document.getElementById("mode2Btn");
      const modeDescription = document.getElementById("modeDescription");

      // è®¾ç½®èœå•å…ƒç´ 
      const settingsButton = document.getElementById("settingsButton");
      const settingsDropdown = document.getElementById("settingsDropdown");
      const settingsClose = document.getElementById("settingsClose");
      const settingsSave = document.getElementById("settingsSave");
      const settingsReset = document.getElementById("settingsReset");

      // VAD å‚æ•°æ»‘å—
      const posThreshold = document.getElementById("posThreshold");
      const negThreshold = document.getElementById("negThreshold");
      const redemption = document.getElementById("redemption");
      const preSpeech = document.getElementById("preSpeech");
      const minSpeech = document.getElementById("minSpeech");
      const confidenceThreshold = document.getElementById(
        "confidenceThreshold"
      );
      const systemPrompt = document.getElementById("systemPrompt");
      const promptTemplate = document.getElementById("promptTemplate");
      const inactivitySlider = document.getElementById("inactivityTimeout");
      const inactivityValue = document.getElementById("inactivityValue");

      // ===== è¯­éŸ³æ•´åˆæäº¤ç›¸å…³å˜é‡ =====
      let bufferedTranscripts = []; // æ”¶é›†çš„ç”¨æˆ·è¯­éŸ³æ®µæ–‡æœ¬
      let inactivitySeconds = 4; // é»˜è®¤ç­‰å¾…ç§’æ•°
      let inactivityTimer = null; // å®šæ—¶å™¨å¼•ç”¨
      let lastSpeechTimestamp = 0; // æœ€åä¸€æ®µè¯­éŸ³å®Œæˆçš„æ—¶é—´æˆ³(ms)

      function loadInactivitySetting() {
        const saved = localStorage.getItem("inactivitySeconds");
        if (saved) {
          inactivitySeconds = parseInt(saved) || 4;
        }
        if (inactivitySlider) {
          inactivitySlider.value = inactivitySeconds;
          inactivityValue.textContent = inactivitySeconds;
        }
      }

      function saveInactivitySetting() {
        localStorage.setItem("inactivitySeconds", inactivitySeconds);
      }

      // å½“æ»‘å—å˜åŒ–æ—¶å®æ—¶æ˜¾ç¤º
      if (inactivitySlider) {
        inactivitySlider.addEventListener("input", () => {
          inactivitySeconds = parseInt(inactivitySlider.value);
          inactivityValue.textContent = inactivitySeconds;
        });
      }

      // æ–°çš„ç»Ÿä¸€å¤„ç†ç”¨æˆ·æœ€ç»ˆè¯­éŸ³æ–‡æœ¬çš„å‡½æ•°ï¼ˆä¸ç«‹å³è°ƒç”¨ LLMï¼‰
      function handleUserTranscript(finalText) {
        if (!finalText) return;
        // æ˜¾ç¤ºåˆ°ç•Œé¢ï¼ˆç”¨æˆ·æ°”æ³¡ï¼‰
        appendMessage(currentUser || "æˆ‘", finalText, "user");
        bufferedTranscripts.push(finalText);
        lastSpeechTimestamp = Date.now();
        resetInactivityTimer();
      }

      function resetInactivityTimer() {
        if (inactivityTimer) clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(() => {
          // åˆ¤æ–­æ˜¯å¦è¶…æ—¶
          const now = Date.now();
            // å†æ¬¡ç¡®è®¤æ²¡æœ‰æ–°çš„è¯­éŸ³æ®µè¿›å…¥
          if (now - lastSpeechTimestamp >= inactivitySeconds * 1000) {
            if (bufferedTranscripts.length > 0) {
              const merged = mergeBufferedTranscripts();
              requestLLMReply(merged);
              bufferedTranscripts = [];
            }
          }
        }, inactivitySeconds * 1000 + 50); // +50ms ç¼“å†²
      }

      function mergeBufferedTranscripts() {
        // ç®€å•åˆå¹¶ï¼šç”¨å…¨è§’å¥å·æˆ–ç©ºæ ¼è¿æ¥ï¼Œé¿å…é‡å¤æ ‡ç‚¹
        return bufferedTranscripts
          .map(t => t.trim())
          .filter(t => t.length > 0)
          .join('ã€‚')
          .replace(/([ã€‚ï¼ï¼Ÿ?.!])+(?=ã€‚)/g, '$1')
          .replace(/(ã€‚){2,}/g, 'ã€‚');
      }

      // VAD å‚æ•°æ˜¾ç¤ºå€¼
      const posThresholdValue = document.getElementById("posThresholdValue");
      const negThresholdValue = document.getElementById("negThresholdValue");
      const redemptionValue = document.getElementById("redemptionValue");
      const preSpeechValue = document.getElementById("preSpeechValue");
      const minSpeechValue = document.getElementById("minSpeechValue");
      const confidenceValue = document.getElementById("confidenceValue");

      // å½•éŸ³æ¨¡å¼ç®¡ç†
      let recordingMode = 2; // é»˜è®¤æ¨¡å¼2: ç«¯ç‚¹æ£€æµ‹
      let isPressing = false; // æ¨¡å¼1ä¸“ç”¨ï¼šæ˜¯å¦æ­£åœ¨æŒ‰ä½æŒ‰é’®
      let pressRecordingStream = null; // æ¨¡å¼1ä¸“ç”¨ï¼šå½•éŸ³æµ
      let pressRecorder = null; // æ¨¡å¼1ä¸“ç”¨ï¼šMediaRecorder

      // éº¦å…‹é£ç®¡ç†
      let availableMicrophones = [];
      let selectedMicrophoneId = null;
      let currentMicrophoneId = null;

      // VAD å‚æ•°é…ç½®ï¼ˆé»˜è®¤å€¼ - v3.1 è¾¹ç•Œæ‰©å±•ä¼˜åŒ–ç‰ˆæœ¬ï¼‰
      let vadParams = {
        positiveSpeechThreshold: 0.5, // å¼€å§‹æ£€æµ‹
        negativeSpeechThreshold: 0.4, // ç»“æŸæ£€æµ‹
        redemptionFrames: 12, // åç½®ç¼“å†²ï¼ˆ10â†’12ï¼Œä¿æŠ¤å¥å°¾ï¼‰
        preSpeechPadFrames: 6, // å‰ç½®ç¼“å†²ï¼ˆ5â†’6ï¼Œä¿æŠ¤å¥é¦–ï¼‰
        minSpeechFrames: 4, // æœ€å°è§¦å‘
      };

      // LLM æç¤ºè¯é…ç½®
      let llmSystemPrompt = "";

      // æç¤ºè¯æ¨¡æ¿
      const promptTemplates = {
        dialect:
          "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–¹è¨€ç¿»è¯‘åŠ©æ‰‹ï¼Œæ“…é•¿è¯†åˆ«å’Œç¿»è¯‘å„åœ°æ–¹è¨€ã€‚è¯·ç”¨æ™®é€šè¯å‡†ç¡®ç¿»è¯‘ç”¨æˆ·è¯´çš„æ–¹è¨€å†…å®¹ï¼Œå¹¶è§£é‡Šå…¶å«ä¹‰ã€‚",
        teacher:
          "ä½ æ˜¯ä¸€ä½è€å¿ƒå‹å¥½çš„è¯­è¨€å­¦ä¹ è€å¸ˆï¼Œå¸®åŠ©å­¦ç”Ÿç†è§£å’Œå­¦ä¹ ä¸åŒçš„è¯­è¨€å’Œæ–¹è¨€ã€‚è¯·ç”¨ç®€å•æ˜“æ‡‚çš„æ–¹å¼å›ç­”é—®é¢˜ã€‚",
        friend:
          "ä½ æ˜¯ä¸€ä¸ªå‹å¥½çƒ­æƒ…çš„å¯¹è¯ä¼™ä¼´ï¼Œå–„äºå€¾å¬å’Œäº¤æµã€‚è¯·ç”¨è‡ªç„¶è½»æ¾çš„è¯­æ°”ä¸ç”¨æˆ·å¯¹è¯ã€‚",
        professional:
          "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šé«˜æ•ˆçš„AIåŠ©æ‰‹ï¼Œèƒ½å¤Ÿå‡†ç¡®ç†è§£å¹¶å›åº”ç”¨æˆ·çš„å„ç±»é—®é¢˜å’Œéœ€æ±‚ã€‚",
      };

      // VAD å‚æ•°é¢„è®¾ï¼ˆv3.1 ä¼˜åŒ–ï¼šå¢å¤§è¾¹ç•Œæ‰©å±•ä»¥ä¿æŠ¤å¥é¦–å¥å°¾éŸ³èŠ‚ï¼‰
      const vadPresets = {
        fast: {
          positiveSpeechThreshold: 0.4,
          negativeSpeechThreshold: 0.45,
          redemptionFrames: 10, // v3.1: åç½®ç¼“å†² 8â†’10 (+64ms ä¿æŠ¤å¥å°¾)
          preSpeechPadFrames: 5, // v3.1: å‰ç½®ç¼“å†² 3â†’5 (+64ms ä¿æŠ¤å¥é¦–)
          minSpeechFrames: 3,
          name: "å¿«é€Ÿå“åº”",
        },
        balanced: {
          positiveSpeechThreshold: 0.5,
          negativeSpeechThreshold: 0.4,
          redemptionFrames: 12, // v3.1: åç½®ç¼“å†² 10â†’12 (+64ms ä¿æŠ¤å¥å°¾)
          preSpeechPadFrames: 6, // v3.1: å‰ç½®ç¼“å†² 5â†’6 (+32ms ä¿æŠ¤å¥é¦–)
          minSpeechFrames: 4,
          name: "å¹³è¡¡æ¨¡å¼",
        },
        tolerant: {
          positiveSpeechThreshold: 0.6,
          negativeSpeechThreshold: 0.3,
          redemptionFrames: 18, // v3.1: åç½®ç¼“å†² 16â†’18 (+64ms ä¿æŠ¤å¥å°¾)
          preSpeechPadFrames: 8, // v3.1: å‰ç½®ç¼“å†² 7â†’8 (+32ms ä¿æŠ¤å¥é¦–)
          minSpeechFrames: 5,
          name: "å®¹é”™æ¨¡å¼",
        },
      };

      // ========== è®¾ç½®èœå•åŠŸèƒ½ ==========

      // å¸§æ•°è½¬ç§’æ•°ï¼ˆæ¯å¸§çº¦ 32msï¼‰
      function framesToSeconds(frames) {
        return (frames * 0.032).toFixed(2);
      }

      // æ›´æ–°å‚æ•°æ˜¾ç¤ºå€¼
      function updateParamDisplays() {
        posThresholdValue.textContent = posThreshold.value;
        negThresholdValue.textContent = negThreshold.value;
        redemptionValue.textContent = `${framesToSeconds(redemption.value)}s (${
          redemption.value
        }å¸§)`;
        preSpeechValue.textContent = `${framesToSeconds(preSpeech.value)}s (${
          preSpeech.value
        }å¸§)`;
        minSpeechValue.textContent = `${framesToSeconds(minSpeech.value)}s (${
          minSpeech.value
        }å¸§)`;
        confidenceValue.textContent = confidenceThreshold.value;
      }

      // ä»æ»‘å—åŠ è½½å‚æ•°åˆ° vadParams
      function loadParamsFromUI() {
        vadParams.positiveSpeechThreshold = parseFloat(posThreshold.value);
        vadParams.negativeSpeechThreshold = parseFloat(negThreshold.value);
        vadParams.redemptionFrames = parseInt(redemption.value);
        vadParams.preSpeechPadFrames = parseInt(preSpeech.value);
        vadParams.minSpeechFrames = parseInt(minSpeech.value);
        vadParams.confidenceThreshold = parseFloat(confidenceThreshold.value);
      }

      // ä» vadParams åŠ è½½å‚æ•°åˆ°æ»‘å—
      function loadParamsToUI() {
        posThreshold.value = vadParams.positiveSpeechThreshold;
        negThreshold.value = vadParams.negativeSpeechThreshold;
        redemption.value = vadParams.redemptionFrames;
        preSpeech.value = vadParams.preSpeechPadFrames;
        minSpeech.value = vadParams.minSpeechFrames;
        confidenceThreshold.value = vadParams.confidenceThreshold;
        updateParamDisplays();
      }

      // åº”ç”¨é¢„è®¾
      function applyPreset(presetName) {
        if (vadPresets[presetName]) {
          const preset = vadPresets[presetName];
          vadParams = { ...preset };
          delete vadParams.name; // ç§»é™¤åç§°å±æ€§
          loadParamsToUI();

          // æ›´æ–°é¢„è®¾æŒ‰é’®çŠ¶æ€
          document.querySelectorAll(".preset-btn").forEach((btn) => {
            btn.classList.remove("active");
            if (btn.dataset.preset === presetName) {
              btn.classList.add("active");
            }
          });
        }
      }

      // æ£€æŸ¥æ˜¯å¦ä¸ºè‡ªå®šä¹‰å‚æ•°
      function checkCustomPreset() {
        loadParamsFromUI();
        let isPreset = false;

        for (const [name, preset] of Object.entries(vadPresets)) {
          const matches =
            vadParams.positiveSpeechThreshold ===
              preset.positiveSpeechThreshold &&
            vadParams.negativeSpeechThreshold ===
              preset.negativeSpeechThreshold &&
            vadParams.redemptionFrames === preset.redemptionFrames &&
            vadParams.preSpeechPadFrames === preset.preSpeechPadFrames &&
            vadParams.minSpeechFrames === preset.minSpeechFrames;

          if (matches) {
            document.querySelectorAll(".preset-btn").forEach((btn) => {
              btn.classList.remove("active");
              if (btn.dataset.preset === name) {
                btn.classList.add("active");
              }
            });
            isPreset = true;
            break;
          }
        }

        if (!isPreset) {
          document.querySelectorAll(".preset-btn").forEach((btn) => {
            btn.classList.remove("active");
            if (btn.dataset.preset === "custom") {
              btn.classList.add("active");
            }
          });
        }
      }

      // æ‰“å¼€/å…³é—­è®¾ç½®èœå•
      settingsButton.addEventListener("click", (e) => {
        e.stopPropagation();
        settingsDropdown.classList.toggle("show");
        if (settingsDropdown.classList.contains("show")) {
          loadParamsToUI();
        }
      });

      settingsClose.addEventListener("click", () => {
        settingsDropdown.classList.remove("show");
      });

      // ç‚¹å‡»å¤–éƒ¨å…³é—­è®¾ç½®èœå•
      document.addEventListener("click", (e) => {
        if (
          !settingsDropdown.contains(e.target) &&
          e.target !== settingsButton
        ) {
          settingsDropdown.classList.remove("show");
        }
      });

      // æ»‘å—å˜åŒ–äº‹ä»¶
      posThreshold.addEventListener("input", () => {
        updateParamDisplays();
        checkCustomPreset();
      });

      negThreshold.addEventListener("input", () => {
        updateParamDisplays();
        checkCustomPreset();
      });

      redemption.addEventListener("input", () => {
        updateParamDisplays();
        checkCustomPreset();
      });

      preSpeech.addEventListener("input", () => {
        updateParamDisplays();
        checkCustomPreset();
      });

      minSpeech.addEventListener("input", () => {
        updateParamDisplays();
        checkCustomPreset();
      });

      confidenceThreshold.addEventListener("input", () => {
        updateParamDisplays();
        checkCustomPreset();
      });

      // é¢„è®¾æŒ‰é’®ç‚¹å‡»
      document.querySelectorAll(".preset-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const preset = btn.dataset.preset;
          if (preset !== "custom") {
            applyPreset(preset);
          }
        });
      });

      // ä¿å­˜å¹¶åº”ç”¨å‚æ•°
      settingsSave.addEventListener("click", async () => {
        loadParamsFromUI();

        // ä¿å­˜ç³»ç»Ÿæç¤ºè¯
        llmSystemPrompt = systemPrompt.value.trim();
        localStorage.setItem("llmSystemPrompt", llmSystemPrompt);

        // ä¿å­˜è¯­éŸ³æ•´åˆç­‰å¾…æ—¶é—´
        inactivitySeconds = parseInt(inactivitySlider.value) || inactivitySeconds;
        saveInactivitySetting();

        // ä¿å­˜åˆ° localStorage
        localStorage.setItem("vadParams", JSON.stringify(vadParams));

        // æ£€æŸ¥æ¨¡å‹æ˜¯å¦éœ€è¦åˆ‡æ¢
        const selectedModel = document.getElementById("modelSelect").value;
        const currentModel =
          document.getElementById("currentModelName").textContent;

        if (selectedModel !== currentModel) {
          appendMessage("ç³»ç»Ÿ", `æ­£åœ¨åˆ‡æ¢åˆ°æ¨¡å‹: ${selectedModel}...`);
          try {
            const response = await fetch("http://127.0.0.1:5000/switch_model", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ model: selectedModel }),
            });
            const data = await response.json();
            if (data.success) {
              document.getElementById("currentModelName").textContent =
                selectedModel;
              appendMessage("ç³»ç»Ÿ", ` å·²åˆ‡æ¢åˆ°: ${selectedModel}`);
            } else {
              appendMessage("ç³»ç»Ÿ", ` åˆ‡æ¢å¤±è´¥: ${data.error}`);
            }
          } catch (err) {
            appendMessage("ç³»ç»Ÿ", ` åˆ‡æ¢æ¨¡å‹å¤±è´¥: ${err.message}`);
          }
        }

        // å¦‚æœ VAD æ­£åœ¨è¿è¡Œï¼Œéœ€è¦é‡å¯
        if (isVadActive && recordingMode === 2) {
          stopVadDetection();
          setTimeout(() => {
            startVadDetection();
          }, 100);
          appendMessage("ç³»ç»Ÿ", ` VAD å‚æ•°å·²æ›´æ–°å¹¶é‡å¯`);
        } else {
          appendMessage("ç³»ç»Ÿ", ` VAD å‚æ•°å·²ä¿å­˜ï¼Œå°†åœ¨ä¸‹æ¬¡å¯åŠ¨æ—¶ç”Ÿæ•ˆ`);
        }

        settingsDropdown.classList.remove("show");
        console.log("VAD å‚æ•°å·²ä¿å­˜:", vadParams);
      });

      // æ¢å¤é»˜è®¤å‚æ•°
      settingsReset.addEventListener("click", () => {
        applyPreset("balanced");
        systemPrompt.value = "";
        llmSystemPrompt = "";
        localStorage.removeItem("llmSystemPrompt");
        // é‡ç½®è¯­éŸ³æ•´åˆç­‰å¾…æ—¶é—´ä¸ç¼“å†²
        inactivitySeconds = 4; // é»˜è®¤å€¼
        if (inactivitySlider) inactivitySlider.value = inactivitySeconds;
        if (inactivityValue) inactivityValue.textContent = inactivitySeconds;
        bufferedTranscripts = [];
        if (inactivityTimer) {
          clearTimeout(inactivityTimer);
          inactivityTimer = null;
        }
        saveInactivitySetting();
        appendMessage("ç³»ç»Ÿ", "å·²æ¢å¤ä¸ºå¹³è¡¡æ¨¡å¼é»˜è®¤å‚æ•°ï¼Œæç¤ºè¯ä¸è¯­éŸ³æ•´åˆç­‰å¾…æ—¶é—´å·²é‡ç½®");
      });

      // æç¤ºè¯æ¨¡æ¿é€‰æ‹©
      promptTemplate.addEventListener("change", () => {
        const selected = promptTemplate.value;
        if (selected && promptTemplates[selected]) {
          systemPrompt.value = promptTemplates[selected];
        }
      });

      // é¡µé¢åŠ è½½æ—¶ä» localStorage è¯»å–å‚æ•°
      function loadSavedParams() {
        const saved = localStorage.getItem("vadParams");
        if (saved) {
          try {
            vadParams = JSON.parse(saved);
            console.log("å·²åŠ è½½ä¿å­˜çš„ VAD å‚æ•°:", vadParams);
          } catch (e) {
            console.error("åŠ è½½å‚æ•°å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼", e);
          }
        }

        // åŠ è½½ç³»ç»Ÿæç¤ºè¯
        const savedPrompt = localStorage.getItem("llmSystemPrompt");
        if (savedPrompt) {
          llmSystemPrompt = savedPrompt;
          systemPrompt.value = savedPrompt;
        }
      }

      // åˆå§‹åŒ–ï¼šåŠ è½½ä¿å­˜çš„å‚æ•°
      loadSavedParams();
  // åŠ è½½è¯­éŸ³æ•´åˆæäº¤ç­‰å¾…è®¾ç½®
  loadInactivitySetting();

      // Load current model info
      async function loadCurrentModel() {
        try {
          const response = await fetch("http://127.0.0.1:5000/models");
          if (response.ok) {
            const data = await response.json();
            document.getElementById("currentModelName").textContent =
              data.current;
            document.getElementById("modelSelect").value = data.current;
            console.log("Current model:", data.current);
          }
        } catch (err) {
          console.error("Failed to load model info:", err);
        }
      }

      // Load model info on page load
      loadCurrentModel();

      // ä»æœåŠ¡å™¨è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚æœæœªç™»å½•åˆ™è·³è½¬åˆ°ç™»å½•é¡µï¼‰
      let currentUser = null;
      async function fetchCurrentUser() {
        try {
          const res = await fetch("/me");
          if (res.ok) {
            const data = await res.json();
            currentUser = data.username;
            userNameElement.textContent = currentUser;
            userAvatarElement.textContent = currentUser.charAt(0);
            // åˆå§‹åŒ– WebSocketï¼ˆä¾èµ–ä¼šè¯ï¼‰
            initWebSocket();
          } else {
            // æœªç™»å½•æˆ–ä¼šè¯è¿‡æœŸï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
            window.location.href = "/";
          }
        } catch (err) {
          console.error("è·å–å½“å‰ç”¨æˆ·å¤±è´¥", err);
          window.location.href = "/";
        }
      }

      // ç«‹å³è·å–ç”¨æˆ·ä¿¡æ¯
      fetchCurrentUser();

      // ========== éº¦å…‹é£é€‰æ‹©åŠŸèƒ½ ==========
      // è·å–æ‰€æœ‰å¯ç”¨çš„éŸ³é¢‘è¾“å…¥è®¾å¤‡
      async function getMicrophones() {
        try {
          const devices = await navigator.mediaDevices.enumerateDevices();
          availableMicrophones = devices.filter(
            (device) => device.kind === "audioinput"
          );
          return availableMicrophones;
        } catch (err) {
          console.error("è·å–éº¦å…‹é£åˆ—è¡¨å¤±è´¥:", err);
          appendMessage("ç³»ç»Ÿ", "è·å–éº¦å…‹é£åˆ—è¡¨å¤±è´¥");
          return [];
        }
      }

      // æ˜¾ç¤ºéº¦å…‹é£é€‰æ‹©å™¨
      async function showMicrophoneSelector() {
        // é¦–å…ˆè¯·æ±‚éº¦å…‹é£æƒé™ï¼Œä»¥ä¾¿è·å–è®¾å¤‡æ ‡ç­¾
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          stream.getTracks().forEach((track) => track.stop());
        } catch (err) {
          console.error("è¯·æ±‚éº¦å…‹é£æƒé™å¤±è´¥:", err);
          appendMessage("ç³»ç»Ÿ", "éœ€è¦éº¦å…‹é£æƒé™æ‰èƒ½é€‰æ‹©è®¾å¤‡");
          return;
        }

        const mics = await getMicrophones();
        if (mics.length === 0) {
          appendMessage("ç³»ç»Ÿ", "æœªæ‰¾åˆ°å¯ç”¨çš„éº¦å…‹é£è®¾å¤‡");
          return;
        }

        // æ¸…ç©ºåˆ—è¡¨
        micList.innerHTML = "";

        // åˆ›å»ºéº¦å…‹é£é€‰é¡¹
        mics.forEach((mic) => {
          const item = document.createElement("div");
          item.className = "mic-item";
          if (mic.deviceId === currentMicrophoneId) {
            item.classList.add("selected");
            selectedMicrophoneId = mic.deviceId;
          }
          item.textContent =
            mic.label || `éº¦å…‹é£ ${mic.deviceId.substring(0, 8)}`;
          item.dataset.deviceId = mic.deviceId;

          item.addEventListener("click", () => {
            // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
            micList
              .querySelectorAll(".mic-item")
              .forEach((i) => i.classList.remove("selected"));
            // æ·»åŠ é€‰ä¸­çŠ¶æ€
            item.classList.add("selected");
            selectedMicrophoneId = mic.deviceId;
          });

          micList.appendChild(item);
        });

        // æ˜¾ç¤ºé€‰æ‹©å™¨
        micOverlay.classList.remove("hidden");
        micSelector.classList.remove("hidden");
      }

      // éšè—éº¦å…‹é£é€‰æ‹©å™¨
      function hideMicrophoneSelector() {
        micOverlay.classList.add("hidden");
        micSelector.classList.add("hidden");
      }

      // åº”ç”¨éº¦å…‹é£é€‰æ‹©
      async function applyMicrophoneSelection() {
        if (
          selectedMicrophoneId &&
          selectedMicrophoneId !== currentMicrophoneId
        ) {
          currentMicrophoneId = selectedMicrophoneId;
          appendMessage("ç³»ç»Ÿ", "éº¦å…‹é£å·²åˆ‡æ¢");

          // å¦‚æœæ­£åœ¨è¿›è¡Œè¯­éŸ³æ£€æµ‹ï¼Œéœ€è¦é‡å¯
          if (isVadActive) {
            appendMessage("ç³»ç»Ÿ", "æ­£åœ¨é‡å¯è¯­éŸ³æ£€æµ‹...");
            await stopVadDetection();
            // ç­‰å¾…ä¸€ä¸‹ç¡®ä¿èµ„æºé‡Šæ”¾
            await new Promise((resolve) => setTimeout(resolve, 500));
            await startVadDetection();
          }
        }
        hideMicrophoneSelector();
      }

      // éº¦å…‹é£æŒ‰é’®äº‹ä»¶
      micButton.addEventListener("click", showMicrophoneSelector);
      micCancel.addEventListener("click", hideMicrophoneSelector);
      micConfirm.addEventListener("click", applyMicrophoneSelection);
      micOverlay.addEventListener("click", hideMicrophoneSelector);

      // ========== VAD è¯­éŸ³æ£€æµ‹ç³»ç»Ÿ ==========
      let isVadActive = false;
      let vadStream = null;
      let vadRecorder = null;
      let vadMicVad = null;
      let audioContext = null;
      let currentStreamId = null;
      let vadChunkSeq = 0;

      // åŠ¨æ€åŠ è½½ @ricky0123/vad-web åº“
      async function loadVadLibrary() {
        try {
          console.log("æ£€æŸ¥ VAD åº“...");

          // æ£€æŸ¥åº“æ˜¯å¦å·²ç»åŠ è½½
          if (window.vad) {
            console.log("VAD åº“å·²åŠ è½½", window.vad);
            return window.vad;
          }

          // ç­‰å¾…åº“åŠ è½½ï¼ˆå› ä¸ºå·²åœ¨headä¸­å¼•å…¥ï¼‰
          let attempts = 0;
          while (!window.vad && attempts < 30) {
            await new Promise((resolve) => setTimeout(resolve, 100));
            attempts++;
          }

          if (window.vad) {
            console.log("VAD åº“åŠ è½½æˆåŠŸ", window.vad);
            return window.vad;
          } else {
            console.warn("VAD åº“æœªæ‰¾åˆ°ï¼Œå°†ä½¿ç”¨å†…ç½®æ£€æµ‹");
            return null;
          }
        } catch (error) {
          console.error("VAD åº“æ£€æŸ¥å¤±è´¥:", error);
          return null;
        }
      }

      // å¼€å¯ VAD è¯­éŸ³æ£€æµ‹
      async function startVadDetection() {
        if (isVadActive) return;

        if (!ws || ws.readyState !== WebSocket.OPEN) {
          appendMessage("ç³»ç»Ÿ", "WebSocket æœªè¿æ¥ï¼Œæ— æ³•å¼€å§‹è¯­éŸ³æ£€æµ‹");
          return;
        }

        try {
          // è·å–éº¦å…‹é£æƒé™ï¼Œä½¿ç”¨é€‰å®šçš„è®¾å¤‡
          const constraints = {
            audio: {
              channelCount: 1,
              sampleRate: 16000,
              echoCancellation: true,
              noiseSuppression: true,
            },
          };

          // å¦‚æœæŒ‡å®šäº†éº¦å…‹é£è®¾å¤‡IDï¼Œåˆ™ä½¿ç”¨æŒ‡å®šè®¾å¤‡
          if (currentMicrophoneId) {
            constraints.audio.deviceId = { exact: currentMicrophoneId };
          }

          vadStream = await navigator.mediaDevices.getUserMedia(constraints);

          // å°è¯•åŠ è½½ VAD åº“
          appendMessage("ç³»ç»Ÿ", "æ­£åœ¨åˆå§‹åŒ– Silero VAD...");
          const vad = await loadVadLibrary();

          if (vad && vad.MicVAD) {
            console.log("VAD åº“åŠ è½½æˆåŠŸï¼Œå¼€å§‹åˆå§‹åŒ– MicVAD");
            // ä½¿ç”¨ Silero VAD
            try {
              vadMicVad = await vad.MicVAD.new({
                stream: vadStream,
                onSpeechStart: () => {
                  console.log("æ£€æµ‹åˆ°è¯­éŸ³å¼€å§‹");

                  // å¦‚æœæœ‰æ­£åœ¨è¿›è¡Œçš„å½•éŸ³ï¼Œå…ˆç»“æŸå®ƒ
                  if (currentStreamId) {
                    console.log("âš ï¸ æ£€æµ‹åˆ°æ–°è¯­éŸ³ï¼Œç«‹å³ç»“æŸä¸Šä¸€è¯­éŸ³ç‰‡æ®µ");

                    // åœæ­¢å½“å‰å½•éŸ³
                    if (vadRecorder && vadRecorder.state !== "inactive") {
                      vadRecorder.stop();
                      vadRecorder = null;
                    }

                    // å‘é€ä¸Šä¸€ä¸ªæµçš„ç»“æŸæ¶ˆæ¯
                    const prevStreamId = currentStreamId;
                    const prevEndMsg = {
                      type: "audio-end",
                      sender: currentUser,
                      streamId: prevStreamId,
                      interrupted: true, // æ ‡è®°ä¸ºè¢«ä¸­æ–­
                    };
                    if (ws && ws.readyState === WebSocket.OPEN) {
                      ws.send(JSON.stringify(prevEndMsg));
                      console.log(`å·²å‘é€ä¸­æ–­ç»“æŸä¿¡å·: ${prevStreamId}`);
                    }
                  }

                  // å¼€å§‹æ–°çš„è¯­éŸ³æµ
                  currentStreamId = generateStreamId();
                  vadChunkSeq = 0;

                  // å‘é€éŸ³é¢‘æµå¼€å§‹æ¶ˆæ¯
                  const startMsg = {
                    type: "audio-start",
                    sender: currentUser,
                    mimeType: "audio/webm;codecs=opus",
                    streamId: currentStreamId,
                  };
                  if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify(startMsg));
                    console.log(`å¼€å§‹æ–°è¯­éŸ³æµ: ${currentStreamId}`);
                  }

                  // å¼€å§‹å½•éŸ³
                  startVadRecording();
                },
                onSpeechEnd: (audio) => {
                  console.log("æ£€æµ‹åˆ°è¯­éŸ³ç»“æŸ");

                  // åœæ­¢å½•éŸ³
                  stopVadRecording();

                  // å‘é€éŸ³é¢‘æµç»“æŸæ¶ˆæ¯
                  if (currentStreamId) {
                    const endMsg = {
                      type: "audio-end",
                      sender: currentUser,
                      streamId: currentStreamId,
                    };
                    if (ws && ws.readyState === WebSocket.OPEN) {
                      ws.send(JSON.stringify(endMsg));
                      console.log(`è¯­éŸ³ç»“æŸ: ${currentStreamId}`);
                    }
                    currentStreamId = null;
                  }
                },
                onVADMisfire: () => {
                  console.log("VAD è¯¯è§¦å‘");
                },
                // ä½¿ç”¨å¯é…ç½®çš„ VAD å‚æ•°
                positiveSpeechThreshold: vadParams.positiveSpeechThreshold,
                negativeSpeechThreshold: vadParams.negativeSpeechThreshold,
                redemptionFrames: vadParams.redemptionFrames,
                preSpeechPadFrames: vadParams.preSpeechPadFrames,
                minSpeechFrames: vadParams.minSpeechFrames,
                submitUserSpeechOnPause: true, // åœ¨åœé¡¿æ—¶æäº¤è¯­éŸ³ï¼ˆé€‚åˆä¸­æ–‡é€å¥è¯†åˆ«ï¼‰
              });

              vadMicVad.start();
              isVadActive = true;
              voiceButton.classList.add("active");
              voiceButton.textContent = "å…³é—­è¯­éŸ³æ£€æµ‹";
              appendMessage("ç³»ç»Ÿ", "Silero VAD è¯­éŸ³æ£€æµ‹å·²å¯åŠ¨");
              console.log("å½“å‰ VAD å‚æ•°:", vadParams);
            } catch (vadError) {
              console.error("MicVAD åˆå§‹åŒ–å¤±è´¥:", vadError);
              appendMessage("ç³»ç»Ÿ", "VAD åˆå§‹åŒ–å¤±è´¥ï¼Œåˆ‡æ¢åˆ°åŸºç¡€æ£€æµ‹");
              await startBasicVadDetection();
            }
          } else {
            console.log("VAD åº“ä¸å¯ç”¨ï¼Œä½¿ç”¨åŸºç¡€æ£€æµ‹");
            // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨åŸºç¡€éŸ³é‡æ£€æµ‹
            await startBasicVadDetection();
          }
        } catch (err) {
          console.error("å¯åŠ¨è¯­éŸ³æ£€æµ‹å¤±è´¥:", err);
          appendMessage("ç³»ç»Ÿ", "å¯åŠ¨è¯­éŸ³æ£€æµ‹å¤±è´¥: " + err.message);
          if (vadStream) {
            vadStream.getTracks().forEach((t) => t.stop());
            vadStream = null;
          }
        }
      }

      // åŸºç¡€éŸ³é‡æ£€æµ‹ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
      async function startBasicVadDetection() {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createMediaStreamSource(vadStream);
        const analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        source.connect(analyser);

        const bufferLength = analyser.fftSize;
        const dataArray = new Uint8Array(bufferLength);

        let isSpeaking = false;
        const VOLUME_THRESHOLD = 20; // é™ä½éŸ³é‡é˜ˆå€¼ï¼ˆä»30é™åˆ°20ï¼‰ï¼Œæ›´å®¹æ˜“è§¦å‘ä¸­æ–‡è½»å£°å’Œä½éŸ³è°ƒ
        const SPEECH_START_FRAMES = 2; // å‡å°‘å¼€å§‹å¸§æ•°ï¼ˆä»3é™åˆ°2ï¼‰ï¼Œæ›´å¿«å“åº”ä¸­æ–‡èµ·éŸ³
        const SPEECH_END_FRAMES = 25; // å¤§å¹…å¢åŠ ç»“æŸå¸§æ•°ï¼ˆä»10å¢åˆ°25ï¼‰ï¼Œå®¹å¿ä¸­æ–‡è¯é—´åœé¡¿
        let aboveThresholdCount = 0;
        let belowThresholdCount = 0;

        function checkVolume() {
          if (!isVadActive) return;

          analyser.getByteTimeDomainData(dataArray);
          let sum = 0;
          for (let i = 0; i < bufferLength; i++) {
            const value = Math.abs(dataArray[i] - 128);
            sum += value;
          }
          const average = sum / bufferLength;

          if (average > VOLUME_THRESHOLD) {
            aboveThresholdCount++;
            belowThresholdCount = 0;

            if (!isSpeaking && aboveThresholdCount >= SPEECH_START_FRAMES) {
              isSpeaking = true;
              console.log("æ£€æµ‹åˆ°è¯­éŸ³å¼€å§‹ï¼ˆåŸºç¡€æ£€æµ‹ï¼‰");
              currentStreamId = generateStreamId();
              vadChunkSeq = 0;

              const startMsg = {
                type: "audio-start",
                sender: currentUser,
                mimeType: "audio/webm;codecs=opus",
                streamId: currentStreamId,
              };
              if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(startMsg));
              }
              startVadRecording();
            }
          } else {
            belowThresholdCount++;
            aboveThresholdCount = 0;

            if (isSpeaking && belowThresholdCount >= SPEECH_END_FRAMES) {
              isSpeaking = false;
              console.log("æ£€æµ‹åˆ°è¯­éŸ³ç»“æŸï¼ˆåŸºç¡€æ£€æµ‹ï¼‰");
              stopVadRecording();

              if (currentStreamId) {
                const endMsg = {
                  type: "audio-end",
                  sender: currentUser,
                  streamId: currentStreamId,
                };
                if (ws && ws.readyState === WebSocket.OPEN) {
                  ws.send(JSON.stringify(endMsg));
                }
                currentStreamId = null;
              }
            }
          }

          requestAnimationFrame(checkVolume);
        }

        checkVolume();
        isVadActive = true;
        voiceButton.classList.add("active");
        voiceButton.textContent = "å…³é—­è¯­éŸ³æ£€æµ‹";
        appendMessage("ç³»ç»Ÿ", "åŸºç¡€è¯­éŸ³æ£€æµ‹å·²å¯åŠ¨ï¼ˆåŸºäºéŸ³é‡ï¼‰");
      }

      // å¼€å§‹å½•éŸ³ï¼ˆåœ¨æ£€æµ‹åˆ°è¯­éŸ³æ—¶ï¼‰
      function startVadRecording() {
        if (!vadStream) return;

        const mimeType = MediaRecorder.isTypeSupported("audio/webm;codecs=opus")
          ? "audio/webm;codecs=opus"
          : "audio/webm";

        vadRecorder = new MediaRecorder(vadStream, { mimeType });

        vadRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0 && currentStreamId) {
            try {
              if (ws && ws.readyState === WebSocket.OPEN) {
                const chunkMeta = {
                  type: "audio-chunk",
                  sender: currentUser,
                  streamId: currentStreamId,
                  seq: vadChunkSeq++,
                  mimeType,
                  timestamp: Date.now(),
                };
                ws.send(JSON.stringify(chunkMeta));
                ws.send(e.data);
              }
            } catch (err) {
              console.error("å‘é€éŸ³é¢‘åˆ†ç‰‡å¤±è´¥:", err);
            }
          }
        };

        vadRecorder.start(250); // 250ms åˆ‡ç‰‡
      }

      // åœæ­¢å½•éŸ³
      function stopVadRecording() {
        if (vadRecorder && vadRecorder.state !== "inactive") {
          vadRecorder.stop();
          vadRecorder = null;
        }
      }

      // å…³é—­ VAD è¯­éŸ³æ£€æµ‹
      function stopVadDetection() {
        if (!isVadActive) return;

        isVadActive = false;
        voiceButton.classList.remove("active");
        voiceButton.textContent = "å¼€å¯è¯­éŸ³æ£€æµ‹";

        // åœæ­¢ Silero VAD
        if (vadMicVad) {
          vadMicVad.pause();
          vadMicVad.destroy();
          vadMicVad = null;
        }

        // åœæ­¢å½•éŸ³
        stopVadRecording();

        // åœæ­¢éŸ³é¢‘ä¸Šä¸‹æ–‡
        if (audioContext) {
          audioContext.close();
          audioContext = null;
        }

        // é‡Šæ”¾éº¦å…‹é£
        if (vadStream) {
          vadStream.getTracks().forEach((t) => t.stop());
          vadStream = null;
        }

        appendMessage("ç³»ç»Ÿ", "è¯­éŸ³æ£€æµ‹å·²å…³é—­");
      }

      // ========== æ¨¡å¼åˆ‡æ¢åŠŸèƒ½ ==========
      function switchToMode(mode) {
        // åœæ­¢å½“å‰ä»»ä½•å½•éŸ³
        if (recordingMode === 1 && isPressing) {
          stopPressToTalkRecording();
        } else if (recordingMode === 2 && isVadActive) {
          stopVadDetection();
        }

        recordingMode = mode;

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        if (mode === 1) {
          mode1Btn.classList.add("active");
          mode2Btn.classList.remove("active");
          modeDescription.textContent = "æŒ‰ä½æŒ‰é’®è¯´è¯ï¼Œæ¾å¼€ç»“æŸ";
          voiceButton.textContent = "æŒ‰ä½å½•éŸ³";
          voiceButton.classList.add("press-to-talk");
          voiceButton.classList.remove("active");
          voiceButton.classList.remove("pressing");
        } else {
          mode2Btn.classList.add("active");
          mode1Btn.classList.remove("active");
          modeDescription.textContent = "è‡ªåŠ¨æ£€æµ‹è¯­éŸ³ç«¯ç‚¹";
          voiceButton.textContent = "å¼€å¯è¯­éŸ³æ£€æµ‹";
          voiceButton.classList.remove("press-to-talk");
          voiceButton.classList.remove("active");
          voiceButton.classList.remove("pressing");
        }

        appendMessage(
          "ç³»ç»Ÿ",
          `å·²åˆ‡æ¢åˆ°æ¨¡å¼${mode}: ${modeDescription.textContent}`
        );
      }

      mode1Btn.addEventListener("click", () => switchToMode(1));
      mode2Btn.addEventListener("click", () => switchToMode(2));

      // ========== æ¨¡å¼1: æŒ‰ä½å½•éŸ³åŠŸèƒ½ ==========
      async function startPressToTalkRecording() {
        if (isPressing) return; // é˜²æ­¢é‡å¤å¯åŠ¨

        if (!ws || ws.readyState !== WebSocket.OPEN) {
          appendMessage("ç³»ç»Ÿ", "WebSocket æœªè¿æ¥ï¼Œæ— æ³•å¼€å§‹å½•éŸ³");
          return;
        }

        try {
          isPressing = true;
          voiceButton.classList.add("pressing");

          // è·å–éº¦å…‹é£æƒé™
          const constraints = {
            audio: currentMicrophoneId
              ? { deviceId: { exact: currentMicrophoneId } }
              : true,
          };
          pressRecordingStream = await navigator.mediaDevices.getUserMedia(
            constraints
          );

          // åˆ›å»º MediaRecorder
          pressRecorder = new MediaRecorder(pressRecordingStream, {
            mimeType: "audio/webm;codecs=opus",
          });

          // ç”ŸæˆæµID
          currentStreamId = Date.now().toString();
          vadChunkSeq = 0;

          pressRecorder.ondataavailable = (e) => {
            if (e.data.size > 0 && ws && ws.readyState === WebSocket.OPEN) {
              vadChunkSeq++;
              const metadata = {
                type: "audio_stream",
                sender: currentUser || "æœªçŸ¥",
                streamId: currentStreamId,
                chunkSeq: vadChunkSeq,
                timestamp: Date.now(),
                mimeType: "audio/webm",
              };

              // å‘é€å…ƒæ•°æ®
              ws.send(JSON.stringify(metadata));
              // å‘é€éŸ³é¢‘æ•°æ®
              ws.send(e.data);

              console.log(
                `[æ¨¡å¼1] å‘é€éŸ³é¢‘å— ${vadChunkSeq}, å¤§å°: ${e.data.size} å­—èŠ‚`
              );
            }
          };

          pressRecorder.onstop = () => {
            console.log("[æ¨¡å¼1] MediaRecorder å·²åœæ­¢");
          };

          pressRecorder.onerror = (e) => {
            console.error("[æ¨¡å¼1] å½•éŸ³é”™è¯¯:", e.error);
            appendMessage("ç³»ç»Ÿ", "å½•éŸ³é”™è¯¯: " + e.error);
            stopPressToTalkRecording();
          };

          pressRecorder.start(250); // æ¯250msä¸€ä¸ªchunk
          console.log("[æ¨¡å¼1] å¼€å§‹æŒ‰ä½å½•éŸ³");
          appendMessage("ç³»ç»Ÿ", "æŒ‰ä½å½•éŸ³ä¸­...");
        } catch (error) {
          console.error("[æ¨¡å¼1] å½•éŸ³å¯åŠ¨å¤±è´¥:", error);
          appendMessage("ç³»ç»Ÿ", "æ— æ³•è®¿é—®éº¦å…‹é£: " + error.message);
          isPressing = false;
          voiceButton.classList.remove("pressing");
        }
      }

      function stopPressToTalkRecording() {
        if (!isPressing) return;

        isPressing = false;
        voiceButton.classList.remove("pressing");

        // åœæ­¢å½•éŸ³ï¼ˆç¡®ä¿æœ€åä¸€å—æ•°æ®è¢«å‘é€ï¼‰
        if (pressRecorder && pressRecorder.state !== "inactive") {
          // å…ˆåœæ­¢å½•éŸ³ï¼Œè¿™ä¼šè§¦å‘æœ€åçš„ ondataavailable äº‹ä»¶
          pressRecorder.stop();

          // å»¶è¿Ÿæ¸…ç†ï¼Œç¡®ä¿æœ€åçš„æ•°æ®å‘é€å®Œæˆ
          setTimeout(() => {
            pressRecorder = null;

            // é‡Šæ”¾æµ
            if (pressRecordingStream) {
              pressRecordingStream.getTracks().forEach((t) => t.stop());
              pressRecordingStream = null;
            }

            // å‘é€æµç»“æŸä¿¡å·
            if (ws && ws.readyState === WebSocket.OPEN && currentStreamId) {
              ws.send(
                JSON.stringify({
                  type: "audio_stream_end",
                  streamId: currentStreamId,
                  sender: currentUser || "æœªçŸ¥",
                })
              );
              console.log("[æ¨¡å¼1] å·²å‘é€æµç»“æŸä¿¡å·");
            }

            currentStreamId = null;
          }, 100);
        } else {
          // å¦‚æœå½•éŸ³å™¨å·²ç»åœæ­¢ï¼Œç›´æ¥æ¸…ç†
          if (pressRecordingStream) {
            pressRecordingStream.getTracks().forEach((t) => t.stop());
            pressRecordingStream = null;
          }
        }

        console.log("[æ¨¡å¼1] ç»“æŸæŒ‰ä½å½•éŸ³");
      }

      // è¯­éŸ³æ£€æµ‹æŒ‰é’®äº‹ä»¶ - æ ¹æ®æ¨¡å¼æ‰§è¡Œä¸åŒé€»è¾‘
      voiceButton.addEventListener("click", () => {
        if (recordingMode === 2) {
          // æ¨¡å¼2: ç«¯ç‚¹æ£€æµ‹ - ç‚¹å‡»åˆ‡æ¢
          if (isVadActive) {
            stopVadDetection();
          } else {
            startVadDetection();
          }
        }
        // æ¨¡å¼1: æŒ‰ä½å½•éŸ³ - ä¸å“åº”ç‚¹å‡»äº‹ä»¶
      });

      // æ¨¡å¼1: æŒ‰ä½å½•éŸ³äº‹ä»¶ (é¼ æ ‡)
      voiceButton.addEventListener("mousedown", (e) => {
        if (recordingMode === 1) {
          e.preventDefault();
          startPressToTalkRecording();
        }
      });

      voiceButton.addEventListener("mouseup", (e) => {
        if (recordingMode === 1) {
          e.preventDefault();
          stopPressToTalkRecording();
        }
      });

      voiceButton.addEventListener("mouseleave", (e) => {
        if (recordingMode === 1 && isPressing) {
          stopPressToTalkRecording();
        }
      });

      // æ¨¡å¼1: æŒ‰ä½å½•éŸ³äº‹ä»¶ (è§¦æ‘¸å±)
      voiceButton.addEventListener("touchstart", (e) => {
        if (recordingMode === 1) {
          e.preventDefault();
          startPressToTalkRecording();
        }
      });

      voiceButton.addEventListener("touchend", (e) => {
        if (recordingMode === 1) {
          e.preventDefault();
          stopPressToTalkRecording();
        }
      });

      voiceButton.addEventListener("touchcancel", (e) => {
        if (recordingMode === 1 && isPressing) {
          stopPressToTalkRecording();
        }
      });

      // ========== é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº ==========
      window.addEventListener("beforeunload", () => {
        if (isPressing) {
          stopPressToTalkRecording();
        }
        if (isVadActive) {
          stopVadDetection();
        }
      });

      // åŸæœ‰çš„ç«¯ç‚¹æ£€æµ‹æŒ‰é’®äº‹ä»¶å¤„ç†å·²åœ¨ä¸Šé¢é‡å†™

      // ========== æ—§çš„è¯­éŸ³è¯†åˆ«ä»£ç ï¼ˆå·²ç¦ç”¨ï¼‰==========
      // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯­éŸ³è¯†åˆ«
      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;
      let recognition = null;

      // æ³¨é‡Šæ‰æ—§çš„è¯­éŸ³è¯†åˆ«åŠŸèƒ½
      /*
      if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = "zh-CN"; // è®¾ç½®è¯­è¨€ä¸ºä¸­æ–‡
        recognition.continuous = false; // å•æ¬¡ä¼šè¯
        recognition.interimResults = true; // å¼€å¯ä¸­é—´ç»“æœä»¥å®ç°æµå¼æ–‡æœ¬

        // ä¸´æ—¶æ˜¾ç¤ºå…ƒç´ ï¼ˆç”¨äºä¸­é—´ç»“æœï¼‰
        let interimElement = null;

        recognition.onresult = (event) => {
          for (let i = event.resultIndex; i < event.results.length; i++) {
            const result = event.results[i];
            const transcript = result[0].transcript.trim();
            const isFinal = result.isFinal;

            // åœ¨é¡µé¢ä¸Šå±•ç¤ºä¸­é—´/æœ€ç»ˆç»“æœ
            if (!isFinal) {
              if (!interimElement) {
                interimElement = document.createElement("div");
                interimElement.className = "interim-message";
                messagesDiv.appendChild(interimElement);
              }
              interimElement.innerHTML = `<strong>${
                currentUser || "æ‚¨"
              } (è¯†åˆ«ä¸­):</strong> ${transcript}`;
              messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } else {
              // æœ€ç»ˆç»“æœï¼šä½¿ç”¨è¯­éŸ³æ•´åˆé€»è¾‘ç¼“å†²ï¼Œä¸ç«‹å³å‘é€ç»™ LLM
              if (interimElement) {
                messagesDiv.removeChild(interimElement);
                interimElement = null;
              }
              messageInput.value = transcript;
              handleUserTranscript(transcript);
            }

            // é€šè¿‡ WebSocket å®æ—¶å‘é€è¯†åˆ«æ–‡æœ¬ï¼ˆstreamingï¼‰
            const payload = {
              sender: currentUser || "æœªçŸ¥",
              text: transcript,
              type: isFinal ? "final" : "interim",
            };
            try {
              if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(payload));
              }
            } catch (e) {
              console.error("å‘é€è¯†åˆ«ç»“æœå¤±è´¥", e);
            }
          }
        };

        recognition.onerror = (event) => {
          console.error("è¯­éŸ³è¯†åˆ«é”™è¯¯:", event.error);
          voiceButton.classList.remove("recording");
          appendMessage("ç³»ç»Ÿ", "è¯­éŸ³è¯†åˆ«å‡ºé”™ï¼Œè¯·é‡è¯•");
        };

        recognition.onend = () => {
          voiceButton.classList.remove("recording");
        };

        voiceButton.addEventListener("click", () => {
          if (voiceButton.classList.contains("recording")) {
            recognition.stop();
          } else {
            // æ¸…ç†è¾“å…¥ä¸å¯èƒ½å­˜åœ¨çš„ä¸´æ—¶å…ƒç´ 
            messageInput.value = "";
            // å¦‚æœæœ‰æ®‹ç•™çš„ interim elementï¼Œç§»é™¤
            const leftover = messagesDiv.querySelector(".interim-message");
            if (leftover) leftover.remove();
            recognition.start();
            voiceButton.classList.add("recording");
          }
        });
      } else {
        voiceButton.style.display = "none";
        appendMessage("ç³»ç»Ÿ", "æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½");
      }
      */

      // WebSocket å»¶ååˆå§‹åŒ–ï¼ˆåœ¨è·å–åˆ°å½“å‰ç”¨æˆ·åå»ºç«‹è¿æ¥ï¼‰
      let ws = null;
      // æ¥æ”¶ç«¯ç¼“å†²ï¼šæŒ‰ sender -> streamId èšåˆåˆ†ç‰‡
      const incomingStreams = {}; // { sender: { streamId: { mimeType, parts: { seq: Blob }, seqs: [] } } }
      // æ¯ä¸ª sender çš„ pending æ§åˆ¶é˜Ÿåˆ—ï¼ˆç”¨äºå°†éšååˆ°è¾¾çš„äºŒè¿›åˆ¶åˆ†ç‰‡ä¸å‰é¢çš„ control åŒ¹é…ï¼‰
      const pendingControls = {}; // { sender: [ { streamId, seq } ] }

      // ç”Ÿæˆéšæœº streamIdï¼ˆæ¯æ¬¡å¼€å§‹æ–°çš„éŸ³é¢‘ä¼šè¯ï¼‰
      function generateStreamId() {
        return (
          Math.random().toString(36).substr(2, 9) +
          "-" +
          Date.now().toString(36)
        );
      }

      // æ–¹ä¾¿å‘ pendingControls æ·»åŠ é¡¹ï¼ˆæœ¬ç«¯è®°å½•ï¼Œå¯é€‰ï¼‰
      function pushPendingControl(sender, streamId, seq) {
        pendingControls[sender] = pendingControls[sender] || [];
        pendingControls[sender].push({ streamId, seq });
      }
      function initWebSocket() {
        if (ws && ws.readyState === WebSocket.OPEN) return;
        ws = new WebSocket(
          (location.protocol === "https:" ? "wss://" : "ws://") + location.host
        );

        ws.onopen = () => {
          appendMessage("ç³»ç»Ÿ", "å·²è¿æ¥åˆ°æœåŠ¡å™¨");
        };

        ws.onmessage = async (event) => {
          try {
            if (typeof event.data === "string") {
              const message = JSON.parse(event.data);
              // audio-start: åˆ›å»ºæµç»“æ„
              if (message.type === "audio-start") {
                incomingStreams[message.sender] =
                  incomingStreams[message.sender] || {};
                incomingStreams[message.sender][message.streamId] = {
                  mimeType: message.mimeType || "audio/webm",
                  parts: {},
                  seqs: [],
                };
                pendingControls[message.sender] =
                  pendingControls[message.sender] || [];
                appendMessage("ç³»ç»Ÿ", `${message.sender} å¼€å§‹è¯­éŸ³æµ`);
                return;
              }

              // audio-end: åˆå¹¶å¹¶æ’­æ”¾è¯¥æµ
              if (message.type === "audio-end") {
                const s =
                  incomingStreams[message.sender] &&
                  incomingStreams[message.sender][message.streamId];
                if (s) {
                  const seqs = s.seqs.slice().sort((a, b) => a - b);
                  const parts = seqs.map((q) => s.parts[q]).filter(Boolean);
                  if (parts.length) {
                    const blob = new Blob(parts, {
                      type: s.mimeType || "audio/webm",
                    });
                    const url = URL.createObjectURL(blob);
                    const audio = new Audio(url);
                    audio
                      .play()
                      .catch((err) => console.error("æ’­æ”¾éŸ³é¢‘å¤±è´¥", err));
                  }
                  delete incomingStreams[message.sender][message.streamId];
                }
                appendMessage("ç³»ç»Ÿ", `${message.sender} ç»“æŸè¯­éŸ³æµ`);
                return;
              }

              // audio-chunk: è®°å½•æ§åˆ¶å…ƒä¿¡æ¯ï¼Œç­‰å¾…éšåäºŒè¿›åˆ¶åŒ¹é…
              if (message.type === "audio-chunk") {
                pendingControls[message.sender] =
                  pendingControls[message.sender] || [];
                incomingStreams[message.sender] =
                  incomingStreams[message.sender] || {};
                incomingStreams[message.sender][message.streamId] =
                  incomingStreams[message.sender][message.streamId] || {
                    mimeType: message.mimeType || "audio/webm",
                    parts: {},
                    seqs: [],
                  };
                if (
                  !incomingStreams[message.sender][
                    message.streamId
                  ].seqs.includes(message.seq)
                ) {
                  incomingStreams[message.sender][message.streamId].seqs.push(
                    message.seq
                  );
                }
                pendingControls[message.sender].push({
                  streamId: message.streamId,
                  seq: message.seq,
                });
                return;
              }

              // STT è¯†åˆ«ç»“æœï¼ˆæ¥è‡ªæœåŠ¡ç«¯ï¼‰
              if (message.type === "stt-result") {
                const r = message.result || {};
                const who = message.sender || "ç³»ç»Ÿ";
                if (r.type === "interim") {
                  const interimEl = document.createElement("div");
                  interimEl.className = "interim-message";
                  interimEl.innerHTML = `<strong>${who} (è¯†åˆ«ä¸­):</strong> ${r.text}`;
                  messagesDiv.appendChild(interimEl);
                  messagesDiv.scrollTop = messagesDiv.scrollHeight;
                } else if (r.type === "final") {
                  // ä½¿ç”¨ç¼“å†²é€»è¾‘å¤„ç†æœ€ç»ˆç»“æœ
                  handleUserTranscript(r.text);
                }
                return;
              }

              // æ™®é€šæ–‡æœ¬æ¶ˆæ¯
              appendMessage(message.sender, message.text);
            } else {
              // äºŒè¿›åˆ¶æ•°æ®ï¼ˆBlobï¼‰
              const arrayBuffer = await event.data.arrayBuffer();
              const senders = Object.keys(pendingControls).filter(
                (s) => pendingControls[s] && pendingControls[s].length > 0
              );
              if (senders.length === 0) {
                console.warn("æ”¶åˆ°äºŒè¿›åˆ¶éŸ³é¢‘ä½†æ²¡æœ‰ pending æ§åˆ¶é¡¹ï¼Œå·²ä¸¢å¼ƒ");
                return;
              }
              const sender = senders[0];
              const pending = pendingControls[sender].shift();
              if (!pending) {
                console.warn("pending æ§åˆ¶é¡¹ä¸ºç©ºï¼Œä¸¢å¼ƒåˆ†ç‰‡");
                return;
              }
              const { streamId, seq } = pending;
              incomingStreams[sender] = incomingStreams[sender] || {};
              incomingStreams[sender][streamId] = incomingStreams[sender][
                streamId
              ] || { mimeType: "audio/webm", parts: {}, seqs: [] };
              incomingStreams[sender][streamId].parts[seq] = new Blob([
                arrayBuffer,
              ]);
            }
          } catch (e) {
            console.error("è§£ææ¶ˆæ¯å¤±è´¥", e);
          }
        };

        ws.onclose = () => {
          appendMessage("ç³»ç»Ÿ", "ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥");
        };
      }

      // ========== éŸ³é¢‘æµï¼ˆMediaRecorderï¼‰é‡‡é›†å¹¶é€šè¿‡ WebSocket å‘é€ ==========
      const audioButton = document.getElementById("audioButton");
      let mediaRecorder = null;
      let localStream = null;
      let isStreamingAudio = false;

      async function startAudioStream() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          appendMessage("ç³»ç»Ÿ", "WebSocket æœªè¿æ¥ï¼Œæ— æ³•å¼€å§‹éŸ³é¢‘æµ");
          return;
        }

        try {
          const constraints = { audio: true };

          // å¦‚æœæŒ‡å®šäº†éº¦å…‹é£è®¾å¤‡IDï¼Œåˆ™ä½¿ç”¨æŒ‡å®šè®¾å¤‡
          if (currentMicrophoneId) {
            constraints.audio = { deviceId: { exact: currentMicrophoneId } };
          }

          localStream = await navigator.mediaDevices.getUserMedia(constraints);
        } catch (err) {
          console.error("è·å–éº¦å…‹é£å¤±è´¥", err);
          appendMessage("ç³»ç»Ÿ", "è·å–éº¦å…‹é£å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™");
          return;
        }

        const mimeType = MediaRecorder.isTypeSupported("audio/webm;codecs=opus")
          ? "audio/webm;codecs=opus"
          : "audio/webm";
        mediaRecorder = new MediaRecorder(localStream, { mimeType });

        // ä¸ºæœ¬æ¬¡éŸ³é¢‘ä¼šè¯ç”Ÿæˆ streamId ä¸ seq
        const streamId = generateStreamId();
        let seq = 0;

        mediaRecorder.addEventListener("start", () => {
          isStreamingAudio = true;
          audioButton.textContent = "åœæ­¢éŸ³é¢‘æµ";
          const startMsg = {
            type: "audio-start",
            sender: currentUser,
            mimeType,
            streamId,
          };
          if (ws && ws.readyState === WebSocket.OPEN)
            ws.send(JSON.stringify(startMsg));
        });

        mediaRecorder.addEventListener("dataavailable", (e) => {
          if (e.data && e.data.size > 0) {
            try {
              if (ws && ws.readyState === WebSocket.OPEN) {
                // å…ˆå‘é€ä¸€æ¡åŒ…å« streamId/seq çš„æ§åˆ¶æ¶ˆæ¯ï¼Œå†å‘é€äºŒè¿›åˆ¶åˆ†ç‰‡
                const chunkMeta = {
                  type: "audio-chunk",
                  sender: currentUser,
                  streamId,
                  seq: seq++,
                  mimeType,
                  timestamp: Date.now(),
                };
                // è®°å½•æœ¬ç«¯ pendingï¼ˆå¯ç”¨äºæœ¬åœ°å›æ”¾/è°ƒè¯•ï¼‰
                pushPendingControl(currentUser, streamId, chunkMeta.seq);
                ws.send(JSON.stringify(chunkMeta));
                ws.send(e.data);
              }
            } catch (err) {
              console.error("å‘é€éŸ³é¢‘åˆ†ç‰‡å¤±è´¥", err);
            }
          }
        });

        mediaRecorder.addEventListener("stop", () => {
          isStreamingAudio = false;
          audioButton.textContent = "æµå¼éŸ³é¢‘";
          const endMsg = { type: "audio-end", sender: currentUser, streamId };
          if (ws && ws.readyState === WebSocket.OPEN)
            ws.send(JSON.stringify(endMsg));
          if (localStream) {
            localStream.getTracks().forEach((t) => t.stop());
            localStream = null;
          }
        });

        // ä»¥ 250ms ä¸ºå•ä½åˆ‡ç‰‡
        mediaRecorder.start(250);
      }

      function stopAudioStream() {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
        }
      }

      audioButton.addEventListener("click", () => {
        if (isStreamingAudio) stopAudioStream();
        else startAudioStream();
      });

      // å‘é€æ¶ˆæ¯
      messageForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const text = messageInput.value;
        if (text.trim()) {
          const message = {
            sender: currentUser,
            text: text,
          };
          ws.send(JSON.stringify(message));
          messageInput.value = "";
        }
      });

      // åœ¨æ¶ˆæ¯åŒºåŸŸæ·»åŠ æ–°æ¶ˆæ¯
      function appendMessage(sender, text, type = "normal") {
        const msgDiv = document.createElement("div");
        if (type === "user") {
          msgDiv.className = "user-message";
          msgDiv.innerHTML = `<strong style=\"color: #fff;\">æˆ‘:</strong> ${text}`;
        } else if (type === "ai") {
          msgDiv.className = "ai-message";
          msgDiv.innerHTML = `<strong style=\"color: #222831;\">æ™ºèƒ½ä½“:</strong> <span id='ai-stream-content'></span>`;
          messagesDiv.appendChild(msgDiv);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
          // ä¼ªæµå¼è¾“å‡º Markdown å†…å®¹
          let idx = 0;
          const raw = text;
          const step = 8; // æ¯æ¬¡è¾“å‡ºå­—ç¬¦æ•°ï¼Œå¯è°ƒ
          const aiSpan = msgDiv.querySelector('#ai-stream-content');
          function streamStep() {
            if (idx < raw.length) {
              // åªæ¸²æŸ“åˆ°å½“å‰ä½ç½®
            const partialHtml = window.marked.parse(raw.slice(0, idx + step));
            aiSpan.innerHTML = DOMPurify.sanitize(partialHtml);
              messagesDiv.scrollTop = messagesDiv.scrollHeight;
              idx += step;
              setTimeout(streamStep, 40); // é—´éš”å¯è°ƒ
            } else {
              aiSpan.innerHTML = DOMPurify.sanitize(window.marked.parse(raw));
              messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
          }
          streamStep();
          return;
        } else {
          msgDiv.innerHTML = `<strong>${sender}:</strong> ${text}`;
        }
        messagesDiv.appendChild(msgDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      // è°ƒç”¨è¯­è¨€å¤§æ¨¡å‹æ¥å£
      function requestLLMReply(userText) {
        // æ˜¾ç¤º"æ­£åœ¨æ€è€ƒ"æç¤º
        const thinkingDiv = document.createElement("div");
        thinkingDiv.className = "ai-message";
        thinkingDiv.id = "thinking-message";
        thinkingDiv.innerHTML = `<strong style="color: #222831;">åŠ©æ‰‹:</strong> æ­£åœ¨æ€è€ƒ...`;
        messagesDiv.appendChild(thinkingDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // æ„å»ºè¯·æ±‚ä½“ï¼ŒåŒ…å«ç³»ç»Ÿæç¤ºè¯
        const requestBody = {
          text: userText,
          user: currentUser || "default",
        };

        // å¦‚æœè®¾ç½®äº†ç³»ç»Ÿæç¤ºè¯ï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­
        if (llmSystemPrompt) {
          requestBody.systemPrompt = llmSystemPrompt;
          console.log("[LLM] ä½¿ç”¨ç³»ç»Ÿæç¤ºè¯ç‰‡æ®µ:", llmSystemPrompt.slice(0, 80));
        }

        // è°ƒç”¨åç«¯ LLM API
        fetch("http://localhost:5001/llm", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(requestBody),
        })
          .then((res) => res.json())
          .then((data) => {
            // ç§»é™¤"æ­£åœ¨æ€è€ƒ"æç¤º
            const thinking = document.getElementById("thinking-message");
            if (thinking) {
              thinking.remove();
            }

            if (data.success) {
              appendMessage("åŠ©æ‰‹", data.reply, "ai");
            } else {
              appendMessage(
                "ç³»ç»Ÿ",
                "LLMè°ƒç”¨å¤±è´¥: " + (data.error || "æœªçŸ¥é”™è¯¯")
              );
            }
          })
          .catch((err) => {
            console.error("LLMè°ƒç”¨å¤±è´¥", err);
            // ç§»é™¤"æ­£åœ¨æ€è€ƒ"æç¤º
            const thinking = document.getElementById("thinking-message");
            if (thinking) {
              thinking.remove();
            }
            appendMessage("ç³»ç»Ÿ", "LLMè°ƒç”¨å¤±è´¥: " + err.message);
          });
      }

      // åœ¨è¯­éŸ³è¯†åˆ«æœ€ç»ˆç»“æœå¤„è°ƒç”¨ appendMessage å¹¶é¢„ç•™ LLM å›å¤
      // recognition.onresult = ...
      // ...existing code...
      if (isFinal) {
        appendMessage(currentUser || "æˆ‘", transcript, "user");
        requestLLMReply(transcript); // é¢„ç•™è°ƒç”¨ LLM å›å¤
      }
      // ...existing code...
    </script>
  </body>
</html>
