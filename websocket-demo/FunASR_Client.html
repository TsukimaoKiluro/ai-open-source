<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI æ–¹è¨€è¯†åˆ«åŠ©æ‰‹ - FunASR WSS æ¨¡å¼</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --color-darkest: #222831;
        --color-dark: #393e46;
        --color-primary: #00adb5;
        --color-light: #eeeeee;
        --color-lightest: #eeeeee;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 28px;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 14px;
        opacity: 0.9;
      }

      .content {
        padding: 30px;
      }

      .status-bar {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        padding: 20px;
        background: var(--color-lightest);
        border-radius: 12px;
        border: 1px solid var(--color-border);
      }

      .status-item {
        flex: 1;
        text-align: center;
      }

      .status-label {
        font-size: 12px;
        color: #666;
        margin-bottom: 8px;
      }

      .status-value {
        font-size: 16px;
        font-weight: 600;
        color: var(--color-dark);
      }

      .status-value.connected {
        color: var(--color-success);
      }

      .status-value.disconnected {
        color: var(--color-error);
      }

      .control-panel {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
      }

      .btn {
        flex: 1;
        padding: 15px 30px;
        font-size: 16px;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-primary {
        background: var(--color-primary);
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        background: #357abd;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
      }

      .btn-success {
        background: var(--color-success);
        color: white;
      }

      .btn-success:hover:not(:disabled) {
        background: #3ba314;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(82, 196, 26, 0.4);
      }

      .btn-danger {
        background: var(--color-error);
        color: white;
      }

      .btn-danger:hover:not(:disabled) {
        background: #d9363e;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 77, 79, 0.4);
      }

      .recording-indicator {
        display: none;
        align-items: center;
        justify-content: center;
        gap: 15px;
        padding: 20px;
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        border-radius: 12px;
        color: white;
        margin-bottom: 30px;
        animation: pulse 2s infinite;
      }

      .recording-indicator.active {
        display: flex;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .recording-dot {
        width: 12px;
        height: 12px;
        background: white;
        border-radius: 50%;
        animation: blink 1s infinite;
      }

      @keyframes blink {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.3;
        }
      }

      .result-container {
        margin-top: 30px;
      }

      .result-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--color-dark);
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .result-box {
        min-height: 200px;
        max-height: 400px;
        overflow-y: auto;
        padding: 20px;
        background: var(--color-lightest);
        border: 2px solid var(--color-border);
        border-radius: 12px;
        font-size: 16px;
        line-height: 1.8;
        color: var(--color-dark);
      }

      .result-item {
        padding: 12px;
        margin-bottom: 10px;
        background: white;
        border-radius: 8px;
        border-left: 4px solid var(--color-primary);
      }

      .result-item.partial {
        border-left-color: var(--color-warning);
        opacity: 0.8;
      }

      .result-item.final {
        border-left-color: var(--color-success);
      }

      .result-time {
        font-size: 12px;
        color: #999;
        margin-bottom: 5px;
      }

      .result-text {
        font-size: 16px;
        color: var(--color-dark);
      }

      .empty-message {
        text-align: center;
        color: #999;
        padding: 40px;
      }

      .footer {
        padding: 20px 30px;
        background: var(--color-lightest);
        border-top: 1px solid var(--color-border);
        text-align: center;
        font-size: 14px;
        color: #666;
      }

      .badge {
        display: inline-block;
        padding: 4px 12px;
        font-size: 12px;
        font-weight: 600;
        border-radius: 12px;
        background: var(--color-success);
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ™ï¸ AI æ–¹è¨€è¯†åˆ«åŠ©æ‰‹</h1>
        <p>
          FunASR WebSocket Server (2-Pass) æ¨¡å¼ | VAD â†’ Paraformer â†’ æ ‡ç‚¹æ¢å¤
        </p>
      </div>

      <div class="content">
        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
          <div class="status-item">
            <div class="status-label">è¿æ¥çŠ¶æ€</div>
            <div class="status-value disconnected" id="connectionStatus">
              æœªè¿æ¥
            </div>
          </div>
          <div class="status-item">
            <div class="status-label">è¯†åˆ«çŠ¶æ€</div>
            <div class="status-value" id="recognitionStatus">å°±ç»ª</div>
          </div>
          <div class="status-item">
            <div class="status-label">å·²è¯†åˆ«</div>
            <div class="status-value" id="resultCount">0 æ¡</div>
          </div>
        </div>

        <!-- å½•éŸ³æŒ‡ç¤ºå™¨ -->
        <div class="recording-indicator" id="recordingIndicator">
          <div class="recording-dot"></div>
          <span>ğŸ¤ æ­£åœ¨å½•éŸ³è¯†åˆ«...</span>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
          <button
            class="btn btn-primary"
            id="connectBtn"
            onclick="connectServer()"
          >
            è¿æ¥æœåŠ¡å™¨
          </button>
          <button
            class="btn btn-success"
            id="startBtn"
            onclick="startRecording()"
            disabled
          >
            å¼€å§‹å½•éŸ³
          </button>
          <button
            class="btn btn-danger"
            id="stopBtn"
            onclick="stopRecording()"
            disabled
          >
            åœæ­¢å½•éŸ³
          </button>
        </div>

        <!-- è¯†åˆ«ç»“æœ -->
        <div class="result-container">
          <div class="result-title">
            è¯†åˆ«ç»“æœ
            <span class="badge">2-Pass æµå¼è¯†åˆ«</span>
          </div>
          <div class="result-box" id="resultBox">
            <div class="empty-message">
              æš‚æ— è¯†åˆ«ç»“æœ<br />
              ç‚¹å‡»"å¼€å§‹å½•éŸ³"å¼€å§‹è¯­éŸ³è¯†åˆ«
            </div>
          </div>
        </div>
      </div>

      <div class="footer">
        æ¡‚æ—ç†å·¥å¤§å­¦ AI æ–¹è¨€è¯†åˆ«ç³»ç»Ÿ | FunASR WSS Server æ¨¡å¼
      </div>
    </div>

    <script>
      // å…¨å±€å˜é‡
      let ws = null;
      let mediaRecorder = null;
      let audioStream = null;
      let isRecording = false;
      let resultCount = 0;

      // WebSocket æœåŠ¡å™¨åœ°å€
      const WSS_SERVER_URL = "ws://localhost:10095";

      // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
      function updateStatus(connected, recognizing, count) {
        const connectionStatus = document.getElementById("connectionStatus");
        const recognitionStatus = document.getElementById("recognitionStatus");
        const resultCountEl = document.getElementById("resultCount");

        if (connected !== undefined) {
          connectionStatus.textContent = connected ? "å·²è¿æ¥" : "æœªè¿æ¥";
          connectionStatus.className = connected
            ? "status-value connected"
            : "status-value disconnected";
        }

        if (recognizing !== undefined) {
          recognitionStatus.textContent = recognizing ? "è¯†åˆ«ä¸­" : "å°±ç»ª";
        }

        if (count !== undefined) {
          resultCountEl.textContent = `${count} æ¡`;
        }
      }

      // æ·»åŠ è¯†åˆ«ç»“æœ
      function addResult(text, isFinal = false) {
        const resultBox = document.getElementById("resultBox");

        // æ¸…ç©ºç©ºæ¶ˆæ¯
        if (resultBox.querySelector(".empty-message")) {
          resultBox.innerHTML = "";
        }

        const resultItem = document.createElement("div");
        resultItem.className = `result-item ${isFinal ? "final" : "partial"}`;

        const now = new Date();
        const timeStr = now.toLocaleTimeString("zh-CN");

        resultItem.innerHTML = `
          <div class="result-time">${timeStr} ${
          isFinal ? "[æœ€ç»ˆ]" : "[å®æ—¶]"
        }</div>
          <div class="result-text">${text}</div>
        `;

        resultBox.appendChild(resultItem);
        resultBox.scrollTop = resultBox.scrollHeight;

        if (isFinal) {
          resultCount++;
          updateStatus(undefined, undefined, resultCount);
        }
      }

      // è¿æ¥ WebSocket æœåŠ¡å™¨
      async function connectServer() {
        if (ws && ws.readyState === WebSocket.OPEN) {
          console.log("å·²ç»è¿æ¥åˆ°æœåŠ¡å™¨");
          return;
        }

        try {
          console.log("æ­£åœ¨è¿æ¥æœåŠ¡å™¨:", WSS_SERVER_URL);
          ws = new WebSocket(WSS_SERVER_URL);

          ws.onopen = () => {
            console.log("å·²è¿æ¥åˆ° FunASR WSS Server");
            updateStatus(true, false, resultCount);
            document.getElementById("connectBtn").disabled = true;
            document.getElementById("startBtn").disabled = false;
          };

          ws.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              console.log("æ”¶åˆ°æ¶ˆæ¯:", data);

              if (data.type === "connected") {
                console.log("æœåŠ¡å™¨ç¡®è®¤è¿æ¥");
              } else if (data.type === "started") {
                console.log("å¼€å§‹è¯†åˆ«");
                updateStatus(undefined, true);
              } else if (data.type === "partial_result") {
                console.log("å®æ—¶è¯†åˆ«:", data.text);
                addResult(data.text, false);
              } else if (data.type === "final_result") {
                console.log("æœ€ç»ˆè¯†åˆ«:", data.text);
                if (data.text) {
                  addResult(data.text, true);
                }
                updateStatus(undefined, false);
              } else if (data.type === "error") {
                console.error("è¯†åˆ«é”™è¯¯:", data.text);
                addResult(`é”™è¯¯: ${data.text}`, true);
              }
            } catch (e) {
              console.error("è§£ææ¶ˆæ¯å¤±è´¥:", e);
            }
          };

          ws.onerror = (error) => {
            console.error("WebSocket é”™è¯¯:", error);
            updateStatus(false);
          };

          ws.onclose = () => {
            console.log("ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥");
            updateStatus(false, false);
            document.getElementById("connectBtn").disabled = false;
            document.getElementById("startBtn").disabled = true;
            document.getElementById("stopBtn").disabled = true;

            if (isRecording) {
              stopRecording();
            }
          };
        } catch (error) {
          console.error("è¿æ¥å¤±è´¥:", error);
          alert("è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·ç¡®ä¿ FunASR WSS Server å·²å¯åŠ¨");
        }
      }

      // å¼€å§‹å½•éŸ³
      async function startRecording() {
        if (isRecording) return;
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          alert("è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨");
          return;
        }

        try {
          // è·å–éº¦å…‹é£æƒé™
          audioStream = await navigator.mediaDevices.getUserMedia({
            audio: {
              channelCount: 1,
              sampleRate: 16000,
            },
          });

          // åˆ›å»º MediaRecorder
          mediaRecorder = new MediaRecorder(audioStream, {
            mimeType: "audio/webm;codecs=opus",
          });

          // å‘é€å¼€å§‹ä¿¡å·
          ws.send(JSON.stringify({ type: "start" }));

          // å¤„ç†éŸ³é¢‘æ•°æ®
          mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0 && ws.readyState === WebSocket.OPEN) {
              // ç›´æ¥å‘é€äºŒè¿›åˆ¶éŸ³é¢‘æ•°æ®
              ws.send(event.data);
              console.log("å‘é€éŸ³é¢‘åˆ†ç‰‡:", event.data.size, "å­—èŠ‚");
            }
          };

          mediaRecorder.onstop = () => {
            console.log("å½•éŸ³å·²åœæ­¢");
          };

          // å¼€å§‹å½•éŸ³ï¼ˆæ¯ 250ms å‘é€ä¸€æ¬¡ï¼‰
          mediaRecorder.start(250);
          isRecording = true;

          // æ›´æ–° UI
          document.getElementById("recordingIndicator").classList.add("active");
          document.getElementById("startBtn").disabled = true;
          document.getElementById("stopBtn").disabled = false;

          console.log("å¼€å§‹å½•éŸ³");
        } catch (error) {
          console.error("å¯åŠ¨å½•éŸ³å¤±è´¥:", error);
          alert("æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®");
        }
      }

      // åœæ­¢å½•éŸ³
      function stopRecording() {
        if (!isRecording) return;

        // åœæ­¢ MediaRecorder
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
        }

        // é‡Šæ”¾éº¦å…‹é£
        if (audioStream) {
          audioStream.getTracks().forEach((track) => track.stop());
          audioStream = null;
        }

        // å‘é€åœæ­¢ä¿¡å·
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: "stop" }));
        }

        isRecording = false;

        // æ›´æ–° UI
        document
          .getElementById("recordingIndicator")
          .classList.remove("active");
        document.getElementById("startBtn").disabled = false;
        document.getElementById("stopBtn").disabled = true;

        console.log("â¹ åœæ­¢å½•éŸ³");
      }

      // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿æ¥
      window.addEventListener("load", () => {
        console.log("é¡µé¢åŠ è½½å®Œæˆ");
        // è‡ªåŠ¨è¿æ¥ï¼ˆå¯é€‰ï¼‰
        // connectServer();
      });

      // é¡µé¢å…³é—­å‰æ¸…ç†
      window.addEventListener("beforeunload", () => {
        if (isRecording) {
          stopRecording();
        }
        if (ws) {
          ws.close();
        }
      });
    </script>
  </body>
</html>
